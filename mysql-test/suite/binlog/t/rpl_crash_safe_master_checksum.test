#
# WL#5493 & WL#5440
# Test case5 verifies if a transaction with a wrong crc value
# will be trimmed from the crashed binlog file after
# master restarts when injecting a wrong crc value
# for a statment of the transaction and then setting
# DEBUG POINT to cause master crash.
#

# Don't test this under valgrind, memory leaks will occur
-- source include/not_valgrind.inc
-- source include/not_embedded.inc
-- source include/have_debug.inc
-- source include/have_innodb.inc
-- source include/have_binlog_format_row.inc
-- source include/not_crashrep.inc

call mtr.add_suppression("Attempting backtrace");
call mtr.add_suppression("allocated tablespace *., old maximum was 0");
call mtr.add_suppression("Error in Log_event::read_log_event()");
call mtr.add_suppression("Buffered warning: Performance schema disabled");

# Reset master
RESET MASTER;

CREATE TABLE t1(a LONGBLOB) ENGINE=INNODB;
CREATE TABLE t2(a LONGBLOB) ENGINE=MYISAM;

-- echo # Test case5: Inject wrong value of crc for a log event, and
-- echo #             then set DBUG POINT to casue the master crash.
# Write file to make mysql-test-run.pl expect crash and restart
-- exec echo "wait" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
-- let $binlog_start= query_get_value(SHOW MASTER STATUS, Position, 1)
-- let $binlog_file= query_get_value(SHOW MASTER STATUS, File, 1)
INSERT INTO t2 (a) VALUES (REPEAT('a',1));

BEGIN;
INSERT INTO t1 (a) VALUES (REPEAT('a',1));
SET SESSION debug="d,fault_injection_crc_value";
INSERT INTO t1 (a) VALUES (REPEAT('a',2));
COMMIT;

BEGIN;
INSERT INTO t1 (a) VALUES (REPEAT('a',3));
SET SESSION debug="d,crash_commit_after_prepare";
# Run the crashing query
-- error 2013
COMMIT;

-- source include/wait_until_disconnected.inc
-- enable_reconnect
-- echo # Restart the master server
-- exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
-- source include/wait_until_connected_again.inc
-- disable_reconnect

-- echo # Test the transaction with a log event injected a wrong crc value
-- echo # will be trimmed from the crashed binlog file
-- source include/show_binlog_events.inc

DROP TABLE t1, t2;

