--echo #
--echo # This test shows DISCARD/IMPORT of a remote tablespace.
--echo #

# Not supported in embedded
--source include/not_embedded.inc

-- source include/have_innodb.inc

--disable_query_log
# These values can change during the test
LET $innodb_file_per_table_orig=`select @@innodb_file_per_table`;

# This warning is expected in the log
call mtr.add_suppression("tablespace is set as discarded");

# Set up some variables
LET $MYSQL_DATA_DIR = `select @@datadir`;
LET $data_directory_clause = DATA DIRECTORY='$MYSQL_TMP_DIR/alt_dir';
--enable_query_log

SET default_storage_engine=InnoDB;

SET GLOBAL innodb_file_per_table=ON;

--disable_warnings
DROP TABLE IF EXISTS t1;
--enable_warnings

--echo #
--echo # CREATE TABLE ... DATA DIRECTORY
--echo # combined with  WL#5522 - Transportable Tablespace
--echo # Create the tablespace in MYSQL_TMP_DIR/alt_dir
--echo # InnoDB will create the sub-directories if needed.
--echo # Test that DISCARD and IMPORT work correctly.
--echo #

--replace_result $MYSQL_TMP_DIR MYSQL_TMP_DIR
eval CREATE TABLE t1 (a int KEY, b text) $data_directory_clause;
INSERT INTO t1 VALUES (1, "Create the tablespace");
SELECT * FROM t1;
--echo ### files in MYSQL_DATA_DIR/test
--list_files $MYSQL_DATA_DIR/test
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test

--echo #
--echo # Check that DATA DIRECTORY shows up in the SHOW CREATE TABLE  results.
--echo #
--replace_result $MYSQL_TMP_DIR MYSQL_TMP_DIR
SHOW CREATE TABLE t1;


--echo #
--echo # Backup the cfg and ibd files.
--echo #
FLUSH TABLES t1 FOR EXPORT;
SELECT * FROM t1;
--copy_file $MYSQL_TMP_DIR/alt_dir/test/t1.cfg $MYSQL_TMP_DIR/alt_dir/test/t1.cfg.bak
--copy_file $MYSQL_TMP_DIR/alt_dir/test/t1.ibd $MYSQL_TMP_DIR/alt_dir/test/t1.ibd.bak
UNLOCK TABLES;
--echo ### files in MYSQL_DATA_DIR/test
--list_files $MYSQL_DATA_DIR/test
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test

--echo #
--echo # Do some DDL and DML.
--echo #
INSERT INTO t1 VALUES (2,'Remote table has been FLUSHed and UNLOCKed');
START TRANSACTION;
INSERT INTO t1 VALUES (12,'Transactional record inserted');
COMMIT;
START TRANSACTION;
INSERT INTO t1 VALUES (13,'Rollback this transactional record');
ROLLBACK;
SELECT COUNT(*) FROM t1;
SELECT * FROM t1;
ALTER TABLE t1 DROP PRIMARY KEY;
ALTER TABLE t1 ADD COLUMN c VARCHAR(50) DEFAULT NULL;
INSERT INTO t1(a,b,c) VALUES (2,'Duplicate value since primary key has been dropped','third column added');
SELECT * FROM t1;

--echo #
--echo # Make a second backup of the cfg and ibd files.
--echo #
FLUSH TABLES t1 FOR EXPORT;
SELECT * FROM t1;
--copy_file $MYSQL_TMP_DIR/alt_dir/test/t1.cfg $MYSQL_TMP_DIR/alt_dir/test/t1.cfg.bak2
--copy_file $MYSQL_TMP_DIR/alt_dir/test/t1.ibd $MYSQL_TMP_DIR/alt_dir/test/t1.ibd.bak2
UNLOCK TABLES;
--echo ### files in MYSQL_DATA_DIR/test
--list_files $MYSQL_DATA_DIR/test
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test

--echo #
--echo # DROP the table and make sure all files except the backups are gone.
--echo #
DROP TABLE t1;
--echo ### files in MYSQL_DATA_DIR/test
--list_files $MYSQL_DATA_DIR/test
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test

--echo #
--echo # CREATE the table again.
--echo #
--replace_result $MYSQL_TMP_DIR MYSQL_TMP_DIR
eval CREATE TABLE t1 (a int KEY, b text) $data_directory_clause;
INSERT INTO t1 VALUES (1, "Create the tablespace a second time");
SELECT * FROM t1;

--echo #
--echo # DISCARD existing tablespace so backed-up .ibd which can be imported/restored
--echo #
ALTER TABLE t1 DISCARD TABLESPACE;
--error ER_TABLESPACE_DISCARDED
SELECT * FROM t1;
--echo ### files in MYSQL_DATA_DIR/test
--list_files $MYSQL_DATA_DIR/test
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test

--echo #
--echo # Restore the second backup of cfg and ibd files.
--echo #
--copy_file $MYSQL_TMP_DIR/alt_dir/test/t1.cfg.bak2 $MYSQL_TMP_DIR/alt_dir/test/t1.cfg
--copy_file $MYSQL_TMP_DIR/alt_dir/test/t1.ibd.bak2 $MYSQL_TMP_DIR/alt_dir/test/t1.ibd
--echo "### files in MYSQL_TMP_DIR/alt_dir/test"
--list_files $MYSQL_TMP_DIR/alt_dir/test/

--echo #
--echo # Try to Import the second backup.  These backups have extra DDL and
--echo # do not match the current frm file.
--echo #
--error ER_TABLE_SCHEMA_MISMATCH
ALTER TABLE t1 IMPORT TABLESPACE;
CHECK TABLE t1;
--remove_file $MYSQL_TMP_DIR/alt_dir/test/t1.cfg
--remove_file $MYSQL_TMP_DIR/alt_dir/test/t1.ibd 
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test

--echo #
--echo # Restore the first backup of cfg and ibd files.
--echo #
--copy_file $MYSQL_TMP_DIR/alt_dir/test/t1.cfg.bak $MYSQL_TMP_DIR/alt_dir/test/t1.cfg
--copy_file $MYSQL_TMP_DIR/alt_dir/test/t1.ibd.bak $MYSQL_TMP_DIR/alt_dir/test/t1.ibd
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test

--echo #
--echo # Import the tablespace and do some DDL and DML.
--echo #
ALTER TABLE t1 IMPORT TABLESPACE;
--echo ### files in MYSQL_DATA_DIR/test
--list_files $MYSQL_DATA_DIR/test
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test
CHECK TABLE t1;
SELECT COUNT(*) FROM t1;
SELECT * FROM t1;
INSERT INTO t1 VALUES (2,'Inserted record after IMPORT');
SELECT * FROM t1;
START TRANSACTION;
INSERT INTO t1 VALUES (12,'Transactional record inserted');
COMMIT;
START TRANSACTION;
INSERT INTO t1 VALUES (13,'Rollback this transactional record');
ROLLBACK;
SELECT * FROM t1;
ALTER TABLE t1 DROP PRIMARY KEY;
ALTER TABLE t1 ADD COLUMN c VARCHAR(50) DEFAULT NULL;
INSERT INTO t1(a,b,c) VALUES (2,'Duplicate value since primary key has been dropped','third column added');
SELECT * FROM t1;

--echo #
--echo # Show that the system tables have this table in them correctly.
--echo #
SELECT name,n_cols,file_format,row_format
       FROM information_schema.innodb_sys_tables WHERE name LIKE 'test%';
SELECT name,file_format,row_format
       FROM information_schema.innodb_sys_tablespaces;
--replace_result $MYSQL_TMP_DIR MYSQL_TMP_DIR
SELECT path FROM information_schema.innodb_sys_datafiles;

--echo #
--echo # Drop the imported table and show that the system tables are updated.
--echo #
DROP TABLE t1;
SELECT name,n_cols,file_format,row_format
       FROM information_schema.innodb_sys_tables WHERE name LIKE 'test%';
SELECT name,file_format,row_format
       FROM information_schema.innodb_sys_tablespaces;
SELECT path FROM information_schema.innodb_sys_datafiles;
--echo ### files in MYSQL_DATA_DIR/test
--list_files $MYSQL_DATA_DIR/test
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test

--echo #
--echo # CREATE the table a third time.
--echo #
--replace_result $MYSQL_TMP_DIR MYSQL_TMP_DIR
eval CREATE TABLE t1 (a int KEY, b text) $data_directory_clause;
INSERT INTO t1 VALUES (1, "Create the tablespace a third time");
SELECT * FROM t1;
--echo ### files in MYSQL_DATA_DIR/test
--list_files $MYSQL_DATA_DIR/test
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test

--echo #
--echo # Restart the server
--echo # This test makes sure that you can still execute the FLUSH TABLES command
--echo # after restarting the server and the tablespace can still be found.
--echo #
--source include/restart_mysqld.inc
SET GLOBAL innodb_file_per_table=ON;
--echo ### files in MYSQL_DATA_DIR/test
--list_files $MYSQL_DATA_DIR/test
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test
SELECT * FROM t1;
FLUSH TABLES t1 FOR EXPORT;
SELECT * FROM t1;
UNLOCK TABLES;

--echo #
--echo # Restart the server again.  This test makes sure that you can
--echo # still DISCARD a remote table after restarting the server.
--echo #
--source include/restart_mysqld.inc
SET GLOBAL innodb_file_per_table=ON;
SELECT * FROM t1;
--echo ### files in MYSQL_DATA_DIR/test
--list_files $MYSQL_DATA_DIR/test
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test
ALTER TABLE t1 DISCARD TABLESPACE;
--error ER_TABLESPACE_DISCARDED
SELECT * FROM t1;
--echo ### files in MYSQL_DATA_DIR/test
--list_files $MYSQL_DATA_DIR/test
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test

--echo #
--echo # Restore the backup of *.ibd and *.cfg files 
--echo #
--copy_file $MYSQL_TMP_DIR/alt_dir/test/t1.ibd.bak  $MYSQL_TMP_DIR/alt_dir/test/t1.ibd
--copy_file $MYSQL_TMP_DIR/alt_dir/test/t1.cfg.bak  $MYSQL_TMP_DIR/alt_dir/test/t1.cfg
--echo ### files in MYSQL_DATA_DIR/test
--list_files $MYSQL_DATA_DIR/test
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test

--echo #
--echo # Import the tablespace and check it out.
--echo #
ALTER TABLE t1 IMPORT TABLESPACE;
SELECT * FROM t1;
--replace_result $MYSQL_TMP_DIR MYSQL_TMP_DIR
SHOW CREATE TABLE t1;
--echo ### files in MYSQL_DATA_DIR/test
--list_files $MYSQL_DATA_DIR/test
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test

--echo #
--echo # DISCARD the tablespace again
--echo #
ALTER TABLE t1 DISCARD TABLESPACE;
--error ER_TABLESPACE_DISCARDED
SELECT * FROM t1;
--echo ### files in MYSQL_DATA_DIR/test
--list_files $MYSQL_DATA_DIR/test
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test

--echo #
--echo # Restart the engine while the tablespace is in the discarded state
--echo #
--source include/restart_mysqld.inc
SET GLOBAL innodb_file_per_table=ON;
--error ER_TABLESPACE_DISCARDED
SELECT * FROM t1;
CHECK TABLE t1;

--echo #
--echo # Relocate this discarded file to the default directory
--echo # instead of the remote directory it was discarded from.
--echo # Put cfg, ibt, and idb files into the default directory.
--echo # Delete the isl file and the remote cfg and ibt files.
--echo # Restart the engine again.
--echo # The tablespace is still in the discarded state.
--echo #
--copy_file $MYSQL_TMP_DIR/alt_dir/test/t1.ibd.bak  $MYSQL_DATA_DIR/test/t1.ibd
--copy_file $MYSQL_TMP_DIR/alt_dir/test/t1.cfg.bak  $MYSQL_DATA_DIR/test/t1.cfg
--copy_file $MYSQL_TMP_DIR/alt_dir/test/t1.ibt  $MYSQL_DATA_DIR/test/t1.ibt
--remove_file $MYSQL_DATA_DIR/test/t1.isl
--remove_file $MYSQL_TMP_DIR/alt_dir/test/t1.cfg
--remove_file $MYSQL_TMP_DIR/alt_dir/test/t1.ibt
--echo ### files in MYSQL_DATA_DIR/test
--list_files $MYSQL_DATA_DIR/test
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test
--echo # Restarting ...
--source include/restart_mysqld.inc
SET GLOBAL innodb_file_per_table=ON;
--error ER_TABLESPACE_DISCARDED
SELECT * FROM t1;
CHECK TABLE t1;

--echo #
--echo # Try to import the tablespace.  It can only be imported from
--echo # the location it was discarded from.
--echo # The error message for 1810 (IO_READ_ERROR) refers to a local path
--echo # so do not display it.
--echo #
--disable_result_log
--error ER_IO_READ_ERROR
ALTER TABLE t1 IMPORT TABLESPACE;
--enable_result_log
--error ER_TABLESPACE_DISCARDED
SELECT * FROM t1;
CHECK TABLE t1;

--echo #
--echo # Restore the ibd, ibt and cfg files to the remote directory.
--echo # Delete the ibd, ibt and cfg files from the default directory.
--echo # The isl file is missing, but is no longer needed since the
--echo # remote location is in the data dictionary.
--echo # Import the tablespace and check it out.
--echo #
--copy_file $MYSQL_DATA_DIR/test/t1.ibd  $MYSQL_TMP_DIR/alt_dir/test/t1.ibd
--copy_file $MYSQL_DATA_DIR/test/t1.ibt  $MYSQL_TMP_DIR/alt_dir/test/t1.ibt
--copy_file $MYSQL_DATA_DIR/test/t1.cfg  $MYSQL_TMP_DIR/alt_dir/test/t1.cfg
--remove_file $MYSQL_DATA_DIR/test/t1.ibd
--remove_file $MYSQL_DATA_DIR/test/t1.ibt
--remove_file $MYSQL_DATA_DIR/test/t1.cfg
--echo ### files in MYSQL_DATA_DIR/test
--list_files $MYSQL_DATA_DIR/test
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test
ALTER TABLE t1 IMPORT TABLESPACE;
INSERT INTO t1 VALUES (2, "Insert this record after IMPORT");
SELECT * FROM t1;
--replace_result $MYSQL_TMP_DIR MYSQL_TMP_DIR
SHOW CREATE TABLE t1;

--echo #
--echo # Show that the system tables have this table in them correctly.
--echo #
SELECT name,n_cols,file_format,row_format
       FROM information_schema.innodb_sys_tables WHERE name LIKE 'test%';
SELECT name,file_format,row_format
       FROM information_schema.innodb_sys_tablespaces;
--replace_result $MYSQL_TMP_DIR MYSQL_TMP_DIR
SELECT path FROM information_schema.innodb_sys_datafiles;


--echo #
--echo # Cleanup
--echo #

DROP TABLE t1;
--remove_file $MYSQL_TMP_DIR/alt_dir/test/t1.cfg.bak
--remove_file $MYSQL_TMP_DIR/alt_dir/test/t1.ibd.bak 
--remove_file $MYSQL_TMP_DIR/alt_dir/test/t1.cfg.bak2
--remove_file $MYSQL_TMP_DIR/alt_dir/test/t1.ibd.bak2 
--echo ### files in MYSQL_DATA_DIR/test
--list_files $MYSQL_DATA_DIR/test
--echo ### files in MYSQL_TMP_DIR/alt_dir/test
--list_files $MYSQL_TMP_DIR/alt_dir/test
--rmdir $MYSQL_TMP_DIR/alt_dir/test
--rmdir $MYSQL_TMP_DIR/alt_dir

-- disable_query_log
eval set global innodb_file_per_table=$innodb_file_per_table_orig;
-- enable_query_log

