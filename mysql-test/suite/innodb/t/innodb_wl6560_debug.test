#
# WL#6560: InnoDB: separate tablespace for innodb-temp-tables.
#

--source include/have_innodb.inc
--source include/have_debug.inc

# Valgrind would complain about memory leaks when we crash on purpose.
--source include/not_valgrind.inc
# Embedded server does not support crashing
--source include/not_embedded.inc
# Avoid CrashReporter popup on Mac
--source include/not_crashrep.inc

################################################################################
#
# Will test following scenarios:
# 1.  hit a crash point during tablespace creation to ensure temp-table
#     is recovered correctly.
# 2.  hit a crash point during table creation.
#
################################################################################

#-----------------------------------------------------------------------------
#
# create test-bed
#
let $per_table = `select @@innodb_file_per_table`;
let $format = `select @@innodb_file_format`;

set global innodb_file_per_table = off;
let $MYSQL_TMP_DIR = `select @@tmpdir`;
let SEARCH_FILE = $MYSQLTEST_VARDIR/log/my_restart.err;
let $args = --loose-console > $SEARCH_FILE 2>&1;
let crash = $args --innodb-force-recovery-crash;

#-----------------------------------------------------------------------------
#
# 1. hit a crash point during tablespace creation to ensure temp-table
#    is recovered correctly.
#
--echo "testing creation of tablepsace by enabling error path"
--echo # files in MYSQL_TMP_DIR
--list_files $MYSQL_TMP_DIR/ ib*tmp*
--source include/shutdown_mysqld.inc
--echo "Temp-tablespace removed on shutdown"
--echo # files in MYSQL_TMP_DIR
--list_files $MYSQL_TMP_DIR/ ib*tmp*
--echo --innodb-force-recovery-crash=100
--echo "Next stmt will crash server"
--error 3
--exec $MYSQLD_CMD $crash=100
let SEARCH_PATTERN = InnoDB: Creating shared tablespace for temporary tables;
--source include/search_pattern_in_file.inc
--remove_file $SEARCH_FILE
#
--echo "restarting server in normal mode"
--source include/start_mysqld.inc
--echo # files in MYSQL_TMP_DIR
--list_files $MYSQL_TMP_DIR/ ib*tmp*
use test;
create temporary table t1 (keyc int, c1 char(100), c2 char(100)) engine=innodb;
insert into t1 values (1, 'c', 'b');
select * from t1;
drop table t1;

#-----------------------------------------------------------------------------
#
# 2.  hit a crash point during table creation.
#
--echo "try hitting crash-point during table creation"
--echo # files in MYSQL_TMP_DIR
--list_files $MYSQL_TMP_DIR/ ib*tmp*
set session debug="+d,ib_ddl_crash_during_create";

--exec echo "restart" > $MYSQLTEST_VARDIR/tmp/mysqld.1.expect
--error 2013
create temporary table t1
        (a int, b int, primary key(a), index(b)) engine = innodb;
--enable_reconnect
--source include/wait_until_connected_again.inc
--disable_reconnect
--echo # files in MYSQL_TMP_DIR
--list_files $MYSQL_TMP_DIR/ ib*tmp*
use test;
create temporary table t1
        (a int, b int, primary key(a), index(b)) engine = innodb;
insert into t1 values (1, 2);
select * from t1;
drop table t1;

#-----------------------------------------------------------------------------
#
# remove test-bed
#
eval set global innodb_file_format = $format;
eval set global innodb_file_per_table = $per_table;


