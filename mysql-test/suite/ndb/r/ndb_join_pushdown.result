DROP TABLE IF EXISTS t1,t2,t3,t4;
set @save_ndb_join_pushdown = @@session.ndb_join_pushdown;
set ndb_join_pushdown = on;
CREATE TABLE t1 (
a int NOT NULL,
b int NOT NULL,
c int NOT NULL,
d int NOT NULL,
PRIMARY KEY (`a`,`b`)
) ENGINE=ndbcluster;
insert into t1 values
(1,1,1,1), (2,2,2,2), (3,3,3,3), (4,4,4,4),
(1,2,5,1), (1,3,1,2), (1,4,2,3),
(2,1,3,4), (2,3,4,5), (2,4,5,1),
(3,1,1,2), (3,2,2,3), (3,4,3,4),
(4,1,4,5), (4,2,5,1), (4,3,1,2);
explain
select *
from t1
join t1 as t2 on t2.a = t1.b and t2.b = t1.c;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	ALL	NULL	NULL	NULL	NULL	16	Pushed 2 joins
1	SIMPLE	t2	eq_ref	PRIMARY	PRIMARY	8	test.t1.b,test.t1.c	1	
select *
from t1
join t1 as t2 on t2.a = t1.b and t2.b = t1.c;
a	b	c	d	a	b	c	d
1	1	1	1	1	1	1	1
1	3	1	2	3	1	1	2
1	4	2	3	4	2	5	1
2	1	3	4	1	3	1	2
2	2	2	2	2	2	2	2
2	3	4	5	3	4	3	4
3	1	1	2	1	1	1	1
3	2	2	3	2	2	2	2
3	3	3	3	3	3	3	3
3	4	3	4	4	3	1	2
4	1	4	5	1	4	2	3
4	3	1	2	3	1	1	2
4	4	4	4	4	4	4	4
explain
select *
from t1
left join t1 as t2 on t2.a = t1.b and t2.b = t1.c;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	ALL	NULL	NULL	NULL	NULL	16	Pushed 2 joins
1	SIMPLE	t2	eq_ref	PRIMARY	PRIMARY	8	test.t1.b,test.t1.c	1	
select *
from t1
left join t1 as t2 on t2.a = t1.b and t2.b = t1.c;
a	b	c	d	a	b	c	d
1	1	1	1	1	1	1	1
1	2	5	1	NULL	NULL	NULL	NULL
1	3	1	2	3	1	1	2
1	4	2	3	4	2	5	1
2	1	3	4	1	3	1	2
2	2	2	2	2	2	2	2
2	3	4	5	3	4	3	4
2	4	5	1	NULL	NULL	NULL	NULL
3	1	1	2	1	1	1	1
3	2	2	3	2	2	2	2
3	3	3	3	3	3	3	3
3	4	3	4	4	3	1	2
4	1	4	5	1	4	2	3
4	2	5	1	NULL	NULL	NULL	NULL
4	3	1	2	3	1	1	2
4	4	4	4	4	4	4	4
explain
select *
from t1
join t1 as t2 on t2.a = t1.b and t2.b = t1.c
join t1 as t3 on t3.a = t2.a and t3.b = t2.b;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	ALL	NULL	NULL	NULL	NULL	16	Pushed 2 joins
1	SIMPLE	t2	eq_ref	PRIMARY	PRIMARY	8	test.t1.b,test.t1.c	1	
1	SIMPLE	t3	eq_ref	PRIMARY	PRIMARY	8	test.t1.b,test.t2.b	1	Using where
select *
from t1
join t1 as t2 on t2.a = t1.b and t2.b = t1.c
join t1 as t3 on t3.a = t2.a and t3.b = t2.b;
a	b	c	d	a	b	c	d	a	b	c	d
1	1	1	1	1	1	1	1	1	1	1	1
1	3	1	2	3	1	1	2	3	1	1	2
1	4	2	3	4	2	5	1	4	2	5	1
2	1	3	4	1	3	1	2	1	3	1	2
2	2	2	2	2	2	2	2	2	2	2	2
2	3	4	5	3	4	3	4	3	4	3	4
3	1	1	2	1	1	1	1	1	1	1	1
3	2	2	3	2	2	2	2	2	2	2	2
3	3	3	3	3	3	3	3	3	3	3	3
3	4	3	4	4	3	1	2	4	3	1	2
4	1	4	5	1	4	2	3	1	4	2	3
4	3	1	2	3	1	1	2	3	1	1	2
4	4	4	4	4	4	4	4	4	4	4	4
explain
select *
from t1
join t1 as t2 on t2.a = t1.b and t2.b = t1.c
join t1 as t3 on t3.a = t2.a and t3.b = t2.b;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	ALL	NULL	NULL	NULL	NULL	16	Pushed 2 joins
1	SIMPLE	t2	eq_ref	PRIMARY	PRIMARY	8	test.t1.b,test.t1.c	1	
1	SIMPLE	t3	eq_ref	PRIMARY	PRIMARY	8	test.t1.b,test.t2.b	1	Using where
select *
from t1
join t1 as t2 on t2.a = t1.b and t2.b = t1.c
join t1 as t3 on t3.a = t2.a and t3.b = t2.b;
a	b	c	d	a	b	c	d	a	b	c	d
1	1	1	1	1	1	1	1	1	1	1	1
1	3	1	2	3	1	1	2	3	1	1	2
1	4	2	3	4	2	5	1	4	2	5	1
2	1	3	4	1	3	1	2	1	3	1	2
2	2	2	2	2	2	2	2	2	2	2	2
2	3	4	5	3	4	3	4	3	4	3	4
3	1	1	2	1	1	1	1	1	1	1	1
3	2	2	3	2	2	2	2	2	2	2	2
3	3	3	3	3	3	3	3	3	3	3	3
3	4	3	4	4	3	1	2	4	3	1	2
4	1	4	5	1	4	2	3	1	4	2	3
4	3	1	2	3	1	1	2	3	1	1	2
4	4	4	4	4	4	4	4	4	4	4	4
explain
select *
from t1
join t1 as t2 on t2.a = t1.b and t2.b = t1.c
left join t1 as t3 on t3.a = t2.a and t3.b = t2.b;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	ALL	NULL	NULL	NULL	NULL	16	Pushed 3 joins
1	SIMPLE	t2	eq_ref	PRIMARY	PRIMARY	8	test.t1.b,test.t1.c	1	
1	SIMPLE	t3	eq_ref	PRIMARY	PRIMARY	8	test.t2.a,test.t2.b	1	
select *
from t1
join t1 as t2 on t2.a = t1.b and t2.b = t1.c
left join t1 as t3 on t3.a = t2.a and t3.b = t2.b;
a	b	c	d	a	b	c	d	a	b	c	d
1	1	1	1	1	1	1	1	1	1	1	1
1	3	1	2	3	1	1	2	3	1	1	2
1	4	2	3	4	2	5	1	4	2	5	1
2	1	3	4	1	3	1	2	1	3	1	2
2	2	2	2	2	2	2	2	2	2	2	2
2	3	4	5	3	4	3	4	3	4	3	4
3	1	1	2	1	1	1	1	1	1	1	1
3	2	2	3	2	2	2	2	2	2	2	2
3	3	3	3	3	3	3	3	3	3	3	3
3	4	3	4	4	3	1	2	4	3	1	2
4	1	4	5	1	4	2	3	1	4	2	3
4	3	1	2	3	1	1	2	3	1	1	2
4	4	4	4	4	4	4	4	4	4	4	4
explain
select *
from t1
left join t1 as t2 on t2.a = t1.b and t2.b = t1.c
left join t1 as t3 on t3.a = t2.a and t3.b = t2.b;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	ALL	NULL	NULL	NULL	NULL	16	Pushed 3 joins
1	SIMPLE	t2	eq_ref	PRIMARY	PRIMARY	8	test.t1.b,test.t1.c	1	
1	SIMPLE	t3	eq_ref	PRIMARY	PRIMARY	8	test.t2.a,test.t2.b	1	
select *
from t1
left join t1 as t2 on t2.a = t1.b and t2.b = t1.c
left join t1 as t3 on t3.a = t2.a and t3.b = t2.b;
a	b	c	d	a	b	c	d	a	b	c	d
1	1	1	1	1	1	1	1	1	1	1	1
1	2	5	1	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
1	3	1	2	3	1	1	2	3	1	1	2
1	4	2	3	4	2	5	1	4	2	5	1
2	1	3	4	1	3	1	2	1	3	1	2
2	2	2	2	2	2	2	2	2	2	2	2
2	3	4	5	3	4	3	4	3	4	3	4
2	4	5	1	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
3	1	1	2	1	1	1	1	1	1	1	1
3	2	2	3	2	2	2	2	2	2	2	2
3	3	3	3	3	3	3	3	3	3	3	3
3	4	3	4	4	3	1	2	4	3	1	2
4	1	4	5	1	4	2	3	1	4	2	3
4	2	5	1	NULL	NULL	NULL	NULL	NULL	NULL	NULL	NULL
4	3	1	2	3	1	1	2	3	1	1	2
4	4	4	4	4	4	4	4	4	4	4	4
set ndb_join_pushdown=on;
explain
select *
from t1
join t1 as t2 on t2.a = t1.c and t2.b = t1.d
where t1.a = 2 and t1.b = 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	const	PRIMARY	PRIMARY	8	const,const	1	Pushed 2 joins
1	SIMPLE	t2	eq_ref	PRIMARY	PRIMARY	8	test.t1.c,test.t1.d	1	
select *
from t1
join t1 as t2 on t2.a = t1.c and t2.b = t1.d
where t1.a = 2 and t1.b = 3;
a	b	c	d	a	b	c	d
explain
select *
from t1
left join t1 as t2 on t2.a = t1.c and t2.b = t1.d
where t1.a = 2 and t1.b = 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	const	PRIMARY	PRIMARY	8	const,const	1	Pushed 2 joins
1	SIMPLE	t2	eq_ref	PRIMARY	PRIMARY	8	test.t1.c,test.t1.d	1	
select *
from t1
left join t1 as t2 on t2.a = t1.c and t2.b = t1.d
where t1.a = 2 and t1.b = 3;
a	b	c	d	a	b	c	d
2	3	4	5	NULL	NULL	NULL	NULL
set ndb_join_pushdown=off;
explain
select *
from t1
join t1 as t2 on t2.a = t1.c and t2.b = t1.d
where t1.a = 2 and t1.b = 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	NULL	NULL	NULL	NULL	NULL	NULL	NULL	Impossible WHERE noticed after reading const tables
select *
from t1
join t1 as t2 on t2.a = t1.c and t2.b = t1.d
where t1.a = 2 and t1.b = 3;
a	b	c	d	a	b	c	d
explain
select *
from t1
left join t1 as t2 on t2.a = t1.c and t2.b = t1.d
where t1.a = 2 and t1.b = 3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	const	PRIMARY	PRIMARY	8	const,const	1	
1	SIMPLE	t2	const	PRIMARY	PRIMARY	8	const,const	0	unique row not found
select *
from t1
left join t1 as t2 on t2.a = t1.c and t2.b = t1.d
where t1.a = 2 and t1.b = 3;
a	b	c	d	a	b	c	d
2	3	4	5	NULL	NULL	NULL	NULL
set ndb_join_pushdown=on;
explain
select *
from t1
join t1 as t2 on t2.a = t1.c and t2.b = t1.d
where t1.a = 1 and t1.b = 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	const	PRIMARY	PRIMARY	8	const,const	1	Pushed 2 joins
1	SIMPLE	t2	eq_ref	PRIMARY	PRIMARY	8	test.t1.c,test.t1.d	1	
select *
from t1
join t1 as t2 on t2.a = t1.c and t2.b = t1.d
where t1.a = 1 and t1.b = 1;
a	b	c	d	a	b	c	d
1	1	1	1	1	1	1	1
explain
select *
from t1
left join t1 as t2 on t2.a = t1.c and t2.b = t1.d
where t1.a = 1 and t1.b = 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	const	PRIMARY	PRIMARY	8	const,const	1	Pushed 2 joins
1	SIMPLE	t2	eq_ref	PRIMARY	PRIMARY	8	test.t1.c,test.t1.d	1	
select *
from t1
left join t1 as t2 on t2.a = t1.c and t2.b = t1.d
where t1.a = 1 and t1.b = 1;
a	b	c	d	a	b	c	d
1	1	1	1	1	1	1	1
set ndb_join_pushdown=off;
explain
select *
from t1
join t1 as t2 on t2.a = t1.c and t2.b = t1.d
where t1.a = 1 and t1.b = 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	const	PRIMARY	PRIMARY	8	const,const	1	
1	SIMPLE	t2	const	PRIMARY	PRIMARY	8	const,const	1	
select *
from t1
join t1 as t2 on t2.a = t1.c and t2.b = t1.d
where t1.a = 1 and t1.b = 1;
a	b	c	d	a	b	c	d
1	1	1	1	1	1	1	1
explain
select *
from t1
left join t1 as t2 on t2.a = t1.c and t2.b = t1.d
where t1.a = 1 and t1.b = 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	const	PRIMARY	PRIMARY	8	const,const	1	
1	SIMPLE	t2	const	PRIMARY	PRIMARY	8	const,const	1	
select *
from t1
left join t1 as t2 on t2.a = t1.c and t2.b = t1.d
where t1.a = 1 and t1.b = 1;
a	b	c	d	a	b	c	d
1	1	1	1	1	1	1	1
set ndb_join_pushdown=on;
explain
select *
from t1
join t1 as t2 on t2.a = t1.c
join t1 as t3 on t3.a = t2.c and t3.b = t2.d
where t1.a = 1 and t1.b = 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	const	PRIMARY	PRIMARY	8	const,const	1	
1	SIMPLE	t2	ref	PRIMARY	PRIMARY	4	test.t1.c	1	Pushed 2 joins
1	SIMPLE	t3	eq_ref	PRIMARY	PRIMARY	8	test.t2.c,test.t2.d	1	
select *
from t1
join t1 as t2 on t2.a = t1.c
join t1 as t3 on t3.a = t2.c and t3.b = t2.d
where t1.a = 1 and t1.b = 1;
a	b	c	d	a	b	c	d	a	b	c	d
1	1	1	1	1	1	1	1	1	1	1	1
1	1	1	1	1	3	1	2	1	2	5	1
1	1	1	1	1	4	2	3	2	3	4	5
explain
select *
from t1
left join t1 as t2 on t2.a = t1.c
left join t1 as t3 on t3.a = t2.c and t3.b = t2.d
where t1.a = 1 and t1.b = 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	const	PRIMARY	PRIMARY	8	const,const	1	
1	SIMPLE	t2	ref	PRIMARY	PRIMARY	4	test.t1.c	1	Pushed 2 joins
1	SIMPLE	t3	eq_ref	PRIMARY	PRIMARY	8	test.t2.c,test.t2.d	1	
select *
from t1
left join t1 as t2 on t2.a = t1.c
left join t1 as t3 on t3.a = t2.c and t3.b = t2.d
where t1.a = 1 and t1.b = 1;
a	b	c	d	a	b	c	d	a	b	c	d
1	1	1	1	1	1	1	1	1	1	1	1
1	1	1	1	1	2	5	1	NULL	NULL	NULL	NULL
1	1	1	1	1	3	1	2	1	2	5	1
1	1	1	1	1	4	2	3	2	3	4	5
set ndb_join_pushdown=off;
explain
select *
from t1
join t1 as t2 on t2.a = t1.c
join t1 as t3 on t3.a = t2.c and t3.b = t2.d
where t1.a = 1 and t1.b = 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	const	PRIMARY	PRIMARY	8	const,const	1	
1	SIMPLE	t2	ref	PRIMARY	PRIMARY	4	const	10	
1	SIMPLE	t3	eq_ref	PRIMARY	PRIMARY	8	test.t2.c,test.t2.d	1	
select *
from t1
join t1 as t2 on t2.a = t1.c
join t1 as t3 on t3.a = t2.c and t3.b = t2.d
where t1.a = 1 and t1.b = 1;
a	b	c	d	a	b	c	d	a	b	c	d
1	1	1	1	1	1	1	1	1	1	1	1
1	1	1	1	1	3	1	2	1	2	5	1
1	1	1	1	1	4	2	3	2	3	4	5
explain
select *
from t1
left join t1 as t2 on t2.a = t1.c
left join t1 as t3 on t3.a = t2.c and t3.b = t2.d
where t1.a = 1 and t1.b = 1;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	const	PRIMARY	PRIMARY	8	const,const	1	
1	SIMPLE	t2	ref	PRIMARY	PRIMARY	4	const	10	
1	SIMPLE	t3	eq_ref	PRIMARY	PRIMARY	8	test.t2.c,test.t2.d	1	
select *
from t1
left join t1 as t2 on t2.a = t1.c
left join t1 as t3 on t3.a = t2.c and t3.b = t2.d
where t1.a = 1 and t1.b = 1;
a	b	c	d	a	b	c	d	a	b	c	d
1	1	1	1	1	1	1	1	1	1	1	1
1	1	1	1	1	2	5	1	NULL	NULL	NULL	NULL
1	1	1	1	1	3	1	2	1	2	5	1
1	1	1	1	1	4	2	3	2	3	4	5
set ndb_join_pushdown=on;
explain 
select * from t1 x, t1 y, t1 z, t1 where 
y.a=x.d and y.b=x.b and 
z.a=y.d and 
t1.a = z.d and t1.b=z.b;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	x	ALL	NULL	NULL	NULL	NULL	16	Pushed 2 joins
1	SIMPLE	y	eq_ref	PRIMARY	PRIMARY	8	test.x.d,test.x.b	1	
1	SIMPLE	z	ref	PRIMARY	PRIMARY	4	test.y.d	1	Pushed 2 joins
1	SIMPLE	t1	eq_ref	PRIMARY	PRIMARY	8	test.z.d,test.z.b	1	
select * from t1 x, t1 y, t1 z, t1 where 
y.a=x.d and y.b=x.b and 
z.a=y.d and 
t1.a = z.d and t1.b=z.b;
a	b	c	d	a	b	c	d	a	b	c	d	a	b	c	d
1	1	1	1	1	1	1	1	1	1	1	1	1	1	1	1
1	1	1	1	1	1	1	1	1	2	5	1	1	2	5	1
1	1	1	1	1	1	1	1	1	3	1	2	2	3	4	5
1	1	1	1	1	1	1	1	1	4	2	3	3	4	3	4
1	2	5	1	1	2	5	1	1	1	1	1	1	1	1	1
1	2	5	1	1	2	5	1	1	2	5	1	1	2	5	1
1	2	5	1	1	2	5	1	1	3	1	2	2	3	4	5
1	2	5	1	1	2	5	1	1	4	2	3	3	4	3	4
1	4	2	3	3	4	3	4	4	2	5	1	1	2	5	1
1	4	2	3	3	4	3	4	4	3	1	2	2	3	4	5
1	4	2	3	3	4	3	4	4	4	4	4	4	4	4	4
2	2	2	2	2	2	2	2	2	1	3	4	4	1	4	5
2	2	2	2	2	2	2	2	2	2	2	2	2	2	2	2
2	2	2	2	2	2	2	2	2	4	5	1	1	4	2	3
2	4	5	1	1	4	2	3	3	1	1	2	2	1	3	4
2	4	5	1	1	4	2	3	3	2	2	3	3	2	2	3
2	4	5	1	1	4	2	3	3	3	3	3	3	3	3	3
2	4	5	1	1	4	2	3	3	4	3	4	4	4	4	4
3	1	1	2	2	1	3	4	4	2	5	1	1	2	5	1
3	1	1	2	2	1	3	4	4	3	1	2	2	3	4	5
3	1	1	2	2	1	3	4	4	4	4	4	4	4	4	4
3	2	2	3	3	2	2	3	3	1	1	2	2	1	3	4
3	2	2	3	3	2	2	3	3	2	2	3	3	2	2	3
3	2	2	3	3	2	2	3	3	3	3	3	3	3	3	3
3	2	2	3	3	2	2	3	3	4	3	4	4	4	4	4
3	3	3	3	3	3	3	3	3	1	1	2	2	1	3	4
3	3	3	3	3	3	3	3	3	2	2	3	3	2	2	3
3	3	3	3	3	3	3	3	3	3	3	3	3	3	3	3
3	3	3	3	3	3	3	3	3	4	3	4	4	4	4	4
3	4	3	4	4	4	4	4	4	2	5	1	1	2	5	1
3	4	3	4	4	4	4	4	4	3	1	2	2	3	4	5
3	4	3	4	4	4	4	4	4	4	4	4	4	4	4	4
4	2	5	1	1	2	5	1	1	1	1	1	1	1	1	1
4	2	5	1	1	2	5	1	1	2	5	1	1	2	5	1
4	2	5	1	1	2	5	1	1	3	1	2	2	3	4	5
4	2	5	1	1	2	5	1	1	4	2	3	3	4	3	4
4	4	4	4	4	4	4	4	4	2	5	1	1	2	5	1
4	4	4	4	4	4	4	4	4	3	1	2	2	3	4	5
4	4	4	4	4	4	4	4	4	4	4	4	4	4	4	4
explain 
select * from t1 x, t1 y where
x.a <= 2 and
y.a=x.d and y.b=x.b;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	x	range	PRIMARY	PRIMARY	4	NULL	10	Pushed 2 joins; Using where with pushed condition
1	SIMPLE	y	eq_ref	PRIMARY	PRIMARY	8	test.x.d,test.x.b	1	
select * from t1 x, t1 y where
x.a <= 2 and
y.a=x.d and y.b=x.b;
a	b	c	d	a	b	c	d
1	1	1	1	1	1	1	1
1	2	5	1	1	2	5	1
1	3	1	2	2	3	4	5
1	4	2	3	3	4	3	4
2	1	3	4	4	1	4	5
2	2	2	2	2	2	2	2
2	4	5	1	1	4	2	3
explain 
select * from t1 x, t1 y where
(x.a <= 2 or x.a > 3) and
y.a=x.d and y.b=x.b;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	x	range	PRIMARY	PRIMARY	4	NULL	20	Pushed 2 joins; Using where with pushed condition
1	SIMPLE	y	eq_ref	PRIMARY	PRIMARY	8	test.x.d,test.x.b	1	
select * from t1 x, t1 y where
(x.a <= 2 or x.a > 3) and
y.a=x.d and y.b=x.b;
a	b	c	d	a	b	c	d
1	1	1	1	1	1	1	1
1	2	5	1	1	2	5	1
1	3	1	2	2	3	4	5
1	4	2	3	3	4	3	4
2	1	3	4	4	1	4	5
2	2	2	2	2	2	2	2
2	4	5	1	1	4	2	3
4	2	5	1	1	2	5	1
4	3	1	2	2	3	4	5
4	4	4	4	4	4	4	4
set ndb_join_pushdown=on;
drop table t1;
create table t1 (a int, b int, primary key(a)) engine = ndb;
insert into t1 values (0x1f, 0x2f);
insert into t1 values (0x2f, 0x3f);
insert into t1 values (0x3f, 0x1f);
create table t2 (c int, d int, primary key(c)) engine = ndb;
insert into t2 values (0x1f, 0x2f);
insert into t2 values (0x2f, 0x3f);
insert into t2 values (0x3f, 0x1f);
create table t3 (a3 int, b3 int, c3 int, d3 int, primary key(a3, b3)) engine = ndb;
insert into t3 values (0x1f, 0x2f, 1, 0x1f);
insert into t3 values (0x2f, 0x3f, 2, 0x2f);
insert into t3 values (0x3f, 0x1f, 3, 0x3f);
explain
select * from t3 x, t3 y, t1 where y.a3=x.d3 and y.b3=x.b3 and t1.a = y.d3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	x	ALL	NULL	NULL	NULL	NULL	3	Pushed 3 joins
1	SIMPLE	y	eq_ref	PRIMARY	PRIMARY	8	test.x.d3,test.x.b3	1	
1	SIMPLE	t1	eq_ref	PRIMARY	PRIMARY	4	test.y.d3	1	
select * from t3 x, t3 y, t1 where y.a3=x.d3 and y.b3=x.b3 and t1.a = y.d3;
a3	b3	c3	d3	a3	b3	c3	d3	a	b
31	47	1	31	31	47	1	31	31	47
47	63	2	47	47	63	2	47	47	63
63	31	3	63	63	31	3	63	63	31
explain
select *
from t3 x, t3 y, t3 z, t3 z2, t1
where y.a3=x.d3 and y.b3=x.b3 and
z.a3=y.d3 and z.b3=y.b3 and
z2.a3=z.d3 and z2.b3=z.b3 and
t1.a = z2.d3;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	x	ALL	NULL	NULL	NULL	NULL	3	Pushed 2 joins
1	SIMPLE	y	eq_ref	PRIMARY	PRIMARY	8	test.x.d3,test.x.b3	1	
1	SIMPLE	z	eq_ref	PRIMARY	PRIMARY	8	test.y.d3,test.x.b3	1	
1	SIMPLE	z2	eq_ref	PRIMARY	PRIMARY	8	test.z.d3,test.y.b3	1	Pushed 2 joins; Using where
1	SIMPLE	t1	eq_ref	PRIMARY	PRIMARY	4	test.z2.d3	1	
select *
from t3 x, t3 y, t3 z, t3 z2, t1
where y.a3=x.d3 and y.b3=x.b3 and
z.a3=y.d3 and z.b3=y.b3 and
z2.a3=z.d3 and z2.b3=z.b3 and
t1.a = z2.d3;
a3	b3	c3	d3	a3	b3	c3	d3	a3	b3	c3	d3	a3	b3	c3	d3	a	b
31	47	1	31	31	47	1	31	31	47	1	31	31	47	1	31	31	47
47	63	2	47	47	63	2	47	47	63	2	47	47	63	2	47	47	63
63	31	3	63	63	31	3	63	63	31	3	63	63	31	3	63	63	31
insert into t1 values (0x4f, null);
select * from t1 left join t1 as t2 on t2.a = t1.b;
a	b	a	b
31	47	47	63
47	63	63	31
63	31	31	47
79	NULL	NULL	NULL
drop table t1,t2,t3;
create table t1 (a int primary key, b int, c int, index(b,c)) engine = ndb;
insert into t1 values (1,null, 2);
insert into t1 values (2,1, null);
insert into t1 values (3,2,2);
insert into t1 values (4,null, 2);
insert into t1 values (5,1, null);
insert into t1 values (6,2,2);
analyze table t1;
Table	Op	Msg_type	Msg_text
test.t1	analyze	status	OK
set ndb_join_pushdown=off;
select *
from t1
join t1 as t2 on (t2.b = t1.b or t2.b = t1.a)
join t1 as t3 on t3.a = t2.a
join t1 as t4 on t4.a = t3.b
;
a	b	c	a	b	c	a	b	c	a	b	c
1	NULL	2	2	1	NULL	2	1	NULL	1	NULL	2
1	NULL	2	5	1	NULL	5	1	NULL	1	NULL	2
2	1	NULL	2	1	NULL	2	1	NULL	1	NULL	2
2	1	NULL	3	2	2	3	2	2	2	1	NULL
2	1	NULL	5	1	NULL	5	1	NULL	1	NULL	2
2	1	NULL	6	2	2	6	2	2	2	1	NULL
3	2	2	3	2	2	3	2	2	2	1	NULL
3	2	2	6	2	2	6	2	2	2	1	NULL
5	1	NULL	2	1	NULL	2	1	NULL	1	NULL	2
5	1	NULL	5	1	NULL	5	1	NULL	1	NULL	2
6	2	2	3	2	2	3	2	2	2	1	NULL
6	2	2	6	2	2	6	2	2	2	1	NULL
set ndb_join_pushdown=on;
select *
from t1
join t1 as t2 on (t2.b = t1.b or t2.b = t1.a)
join t1 as t3 on t3.a = t2.a
join t1 as t4 on t4.a = t3.b
;
a	b	c	a	b	c	a	b	c	a	b	c
1	NULL	2	2	1	NULL	2	1	NULL	1	NULL	2
1	NULL	2	5	1	NULL	5	1	NULL	1	NULL	2
2	1	NULL	2	1	NULL	2	1	NULL	1	NULL	2
2	1	NULL	3	2	2	3	2	2	2	1	NULL
2	1	NULL	5	1	NULL	5	1	NULL	1	NULL	2
2	1	NULL	6	2	2	6	2	2	2	1	NULL
3	2	2	3	2	2	3	2	2	2	1	NULL
3	2	2	6	2	2	6	2	2	2	1	NULL
5	1	NULL	2	1	NULL	2	1	NULL	1	NULL	2
5	1	NULL	5	1	NULL	5	1	NULL	1	NULL	2
6	2	2	3	2	2	3	2	2	2	1	NULL
6	2	2	6	2	2	6	2	2	2	1	NULL
drop table t1;
set ndb_join_pushdown = @save_ndb_join_pushdown;
