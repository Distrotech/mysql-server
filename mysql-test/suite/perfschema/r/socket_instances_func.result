CREATE TEMPORARY TABLE my_socket_instances AS
SELECT * FROM performance_schema.socket_instances;
SELECT THREAD_ID INTO @thread_id
FROM performance_schema.threads
WHERE PROCESSLIST_ID = CONNECTION_ID();
# Establish local unix domain connection (con1,localhost,root,,test,,)
SELECT THREAD_ID INTO @thread_id
FROM performance_schema.threads
WHERE PROCESSLIST_ID = CONNECTION_ID();
# Establish local TCP/IP connection (con1,127.0.0.1,root,,test,,)
SELECT THREAD_ID INTO @thread_id
FROM performance_schema.threads
WHERE PROCESSLIST_ID = CONNECTION_ID();
# Switch to connection default
# EVENT_NAME is the "wait/io/socket/*" instrument identifier.
SELECT COUNT(*) = 0 AS "Expect 1"
FROM performance_schema.socket_instances
WHERE EVENT_NAME NOT LIKE 'wait/io/socket/%';
Expect 1
1
SELECT DISTINCT EVENT_NAME
FROM performance_schema.socket_instances
ORDER BY EVENT_NAME;
EVENT_NAME
wait/io/socket/com/client_connection
wait/io/socket/com/server_tcpip_socket
wait/io/socket/com/server_unix_socket
# OBJECT_INSTANCE_BEGIN is an arbitrary identifier, guaranteed to be unique.
SELECT COUNT(*) = COUNT(DISTINCT OBJECT_INSTANCE_BEGIN) AS "Expect 1"
FROM performance_schema.socket_instances;
Expect 1
1
# SOCKET_ID is the internal file handle assigned to the socket.
SELECT COUNT(*) = COUNT(DISTINCT SOCKET_ID) AS "Expect 1"
FROM performance_schema.socket_instances;
Expect 1
1
# Characteristics per our thread
#    There must be only one entry with our thread_id
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = @thread_id;
Expect 1
1
#    Check the content.
SELECT EVENT_NAME = 'wait/io/socket/com/client_connection' AND IP = ''
   AND PORT = 0 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = @thread_id;
Expect 1
1
# Characteristics of 'server_tcpip_socket' entry
#    Server listening socket, TCP/IP
#    There is only one entry with 'wait/io/socket/com/server_tcpip_socket'.
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE EVENT_NAME = 'wait/io/socket/com/server_tcpip_socket';
Expect 1
1
#    Check the content.
SELECT THREAD_ID = 1 AND PORT = <MASTER_MYPORT> AND IP = '0.0.0.0'
     AND STATE = 'ACTIVE' AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE EVENT_NAME = 'wait/io/socket/com/server_tcpip_socket';
Expect 1
1
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE EVENT_NAME = 'wait/io/socket/com/server_unix_socket';
Expect 1
1
#    Check the content.
SELECT THREAD_ID = 1 AND PORT = 0 AND IP = ''
     AND STATE = 'ACTIVE' AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE EVENT_NAME = 'wait/io/socket/com/server_unix_socket';
Expect 1
1
# Server listening sockets (TCP and Unix) are handled on thread 1
SELECT COUNT(*) = 2 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = 1;
Expect 1
1
# Characteristics of entries with THREAD_ID of con1
#    There is only one entry with this id.
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = <con1_thread_id>;
Expect 1
1
#    Check the content.
SELECT EVENT_NAME = 'wait/io/socket/com/client_connection' AND IP = ''
     AND PORT = 0 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = <con1_thread_id>;
Expect 1
1
# Characteristics of entries with THREAD_ID of con2
#    There is only one entry with this id.
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = <con2_thread_id>;
Expect 1
1
#    Check the content.
SELECT EVENT_NAME = 'wait/io/socket/com/client_connection' AND IP = '127.0.0.1'
     AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = <con2_thread_id>;
Expect 1
1
# Show differences to socket_instances before con1,con2 connecting
SELECT EVENT_NAME, IP
FROM performance_schema.socket_instances
WHERE (EVENT_NAME,OBJECT_INSTANCE_BEGIN,THREAD_ID,SOCKET_ID,IP,PORT,STATE)
NOT IN (SELECT EVENT_NAME,OBJECT_INSTANCE_BEGIN,THREAD_ID,SOCKET_ID,IP,PORT,STATE
FROM my_socket_instances)
ORDER BY THREAD_ID;
EVENT_NAME	IP
wait/io/socket/com/client_connection	
wait/io/socket/com/client_connection	127.0.0.1
# Disconnect con1 and con2
# Show differences to socket_instances before con1,con2 connecting.
# There should be none.
SELECT *
FROM performance_schema.socket_instances
WHERE (EVENT_NAME,OBJECT_INSTANCE_BEGIN,THREAD_ID,SOCKET_ID,IP,PORT,STATE)
NOT IN (SELECT EVENT_NAME,OBJECT_INSTANCE_BEGIN,THREAD_ID,SOCKET_ID,IP,PORT,STATE
FROM my_socket_instances)
ORDER BY THREAD_ID;
EVENT_NAME	OBJECT_INSTANCE_BEGIN	THREAD_ID	SOCKET_ID	IP	PORT	STATE
