# DEBUG 0 - ENV
DYLD_LIBRARY_PATH=/home/cpowers/work/dev/mysql-trunk-wl4896/libmysql/.libs/:/home/cpowers/work/dev/mysql-trunk-wl4896/libmysql_r/.libs/:/home/cpowers/work/dev/mysql-trunk-wl4896/zlib/.libs/
LD_LIBRARY_PATH=/home/cpowers/work/dev/mysql-trunk-wl4896/libmysql/.libs/:/home/cpowers/work/dev/mysql-trunk-wl4896/libmysql_r/.libs/:/home/cpowers/work/dev/mysql-trunk-wl4896/zlib/.libs/:/usr/lib64/mpi/gcc/openmpi/lib64
LIBPATH=/home/cpowers/work/dev/mysql-trunk-wl4896/libmysql/.libs/:/home/cpowers/work/dev/mysql-trunk-wl4896/libmysql_r/.libs/:/home/cpowers/work/dev/mysql-trunk-wl4896/zlib/.libs/
MYSQL_BINDIR=/home/cpowers/work/dev/mysql-trunk-wl4896
MYSQL_BINLOG=/home/cpowers/work/dev/mysql-trunk-wl4896/client//mysqlbinlog --defaults-file=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test/var/my.cnf
MYSQL_BUG25714=/home/cpowers/work/dev/mysql-trunk-wl4896/tests/bug25714
MYSQL_BUG=
MYSQL_CHARSETSDIR=/home/cpowers/work/dev/mysql-trunk-wl4896/sql/share/charsets
MYSQL_CHECK=/home/cpowers/work/dev/mysql-trunk-wl4896/client//mysqlcheck --defaults-file=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test/var/my.cnf
MYSQL_CLIENT_TEST=/home/cpowers/work/dev/mysql-trunk-wl4896/tests/mysql_client_test --defaults-file=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test/var/my.cnf --testcase --vardir=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test/var
MYSQL_DEV=mysql-trunk-wl4896
MYSQL_DUMP=/home/cpowers/work/dev/mysql-trunk-wl4896/client//mysqldump --defaults-file=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test/var/my.cnf --defaults-group-suffix=.1
MYSQL_DUMP_SLAVE=/home/cpowers/work/dev/mysql-trunk-wl4896/client//mysqldump --defaults-file=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test/var/my.cnf --defaults-group-suffix=.2
MYSQL_EMBEDDED=/home/cpowers/work/dev/mysql-trunk-wl4896/libmysqld/examples/mysql_embedded
MYSQL_FIX_PRIVILEGE_TABLES=/home/cpowers/work/dev/mysql-trunk-wl4896/scripts/mysql_fix_privilege_tables.sql
MYSQL_HOST=127.0.0.1
MYSQL_IMPORT=/home/cpowers/work/dev/mysql-trunk-wl4896/client//mysqlimport --defaults-file=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test/var/my.cnf
MYSQL_LIBDIR=/home/cpowers/work/dev/mysql-trunk-wl4896/lib
MYSQL_MACHINE_TYPE=x86_64
MYSQL_MY_PRINT_DEFAULTS=/home/cpowers/work/dev/mysql-trunk-wl4896/extra/my_print_defaults
MYSQL_PORT=9308
MYSQL_SERVER_VERSION=5.6.3-m5
MYSQL_SHAREDIR=/home/cpowers/work/dev/mysql-trunk-wl4896/sql/share
MYSQL_SHOW=/home/cpowers/work/dev/mysql-trunk-wl4896/client//mysqlshow --defaults-file=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test/var/my.cnf
MYSQL_SLAP=/home/cpowers/work/dev/mysql-trunk-wl4896/client//mysqlslap --defaults-file=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test/var/my.cnf
MYSQL_SLAVE=/home/cpowers/work/dev/mysql-trunk-wl4896/client//mysql --defaults-file=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test/var/my.cnf --defaults-group-suffix=.2
MYSQL_SOCK=/home/cpowers/work/etc/mysql-trunk-wl4896/mysql-test/var/tmp/mysqld.1.sock
MYSQL_SYSTEM_ARCHITECTURE=64
MYSQL_SYSTEM_TYPE=Linux
MYSQL_TEST=/home/cpowers/work/dev/mysql-trunk-wl4896/client//mysqltest --defaults-file=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test/var/my.cnf --silent --tmpdir=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test/var/tmp --character-sets-dir=/home/cpowers/work/dev/mysql-trunk-wl4896/sql/share/charsets --logdir=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test/var/log --plugin_dir=/home/cpowers/work/dev/mysql-trunk-wl4896/plugin/auth --database=test --timer-file=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test/var/log/timer
MYSQL_TEST_DIR=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test
MYSQL_TMP_DIR=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test/var/tmp
MYSQL_UPGRADE=/home/cpowers/work/dev/mysql-trunk-wl4896/client//mysql_upgrade --defaults-file=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test/var/my.cnf
MYSQL_USER=root
SHLIB_PATH=/home/cpowers/work/dev/mysql-trunk-wl4896/libmysql/.libs/:/home/cpowers/work/dev/mysql-trunk-wl4896/libmysql_r/.libs/:/home/cpowers/work/dev/mysql-trunk-wl4896/zlib/.libs/
# Take a snapshot of SOCKET_INSTANCES
CREATE TEMPORARY TABLE my_socket_instances AS
SELECT * FROM performance_schema.socket_instances;
# DEBUG 1
SELECT * FROM performance_schema.socket_instances;
EVENT_NAME	OBJECT_INSTANCE_BEGIN	THREAD_ID	SOCKET_ID	IP	PORT	STATE
wait/io/socket/sql/client_connection	140629467156176	16	37		0	ACTIVE
wait/io/socket/sql/server_unix_socket	140629467186192	1	14		0	ACTIVE
wait/io/socket/sql/server_tcpip_socket	140629467267056	1	13	0.0.0.0	13000	ACTIVE
current_user()
root@localhost
user()
root@localhost
EVENT_NAME	OBJECT_INSTANCE_BEGIN	THREAD_ID	SOCKET_ID	IP	PORT	STATE
wait/io/socket/sql/client_connection	140629467156176	16	37		0	ACTIVE
wait/io/socket/sql/server_unix_socket	140629467186192	1	14		0	ACTIVE
wait/io/socket/sql/client_connection	140629467265264	17	60	127.0.0.1	38473	ACTIVE
wait/io/socket/sql/server_tcpip_socket	140629467267056	1	13	0.0.0.0	13000	ACTIVE
# DEBUG 1a
SELECT * FROM performance_schema.socket_instances;
EVENT_NAME	OBJECT_INSTANCE_BEGIN	THREAD_ID	SOCKET_ID	IP	PORT	STATE
wait/io/socket/sql/client_connection	140629467156176	16	37		0	ACTIVE
wait/io/socket/sql/server_unix_socket	140629467186192	1	14		0	ACTIVE
wait/io/socket/sql/server_tcpip_socket	140629467267056	1	13	0.0.0.0	13000	ACTIVE
# Get thread id of the default connection
SELECT THREAD_ID INTO @thread_id
FROM performance_schema.threads
WHERE PROCESSLIST_ID = CONNECTION_ID();
# Establish local TCP/IP connection (con1,127.0.0.1,root,,test,,)
# Connect 1 (con1,127.0.0.1,root,,test,,13000)
# Connect 1a (con1a,127.0.0.1,root,,test,13000)
SELECT * FROM performance_schema.socket_instances;
EVENT_NAME	OBJECT_INSTANCE_BEGIN	THREAD_ID	SOCKET_ID	IP	PORT	STATE
wait/io/socket/sql/client_connection	140629467147216	19	61	127.0.0.1	38475	ACTIVE
wait/io/socket/sql/client_connection	140629467156176	16	37		0	ACTIVE
wait/io/socket/sql/server_unix_socket	140629467186192	1	14		0	ACTIVE
wait/io/socket/sql/client_connection	140629467255408	18	60	127.0.0.1	38474	ACTIVE
wait/io/socket/sql/server_tcpip_socket	140629467267056	1	13	0.0.0.0	13000	ACTIVE
# DEBUG 2 - host, protocol
# /home/cpowers/work/dev/mysql-trunk-wl4896/client//mysql --defaults-file=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test/var/my.cnf --host=127.0.0.1 --protocol=TCP --port=13000 --user=root test -e "SELECT current_user();SELECT user();SELECT * FROM performance_schema.socket_instances;"
current_user()
root@localhost
user()
root@localhost
EVENT_NAME	OBJECT_INSTANCE_BEGIN	THREAD_ID	SOCKET_ID	IP	PORT	STATE
wait/io/socket/sql/client_connection	140629467104208	20	62	127.0.0.1	38476	ACTIVE
wait/io/socket/sql/client_connection	140629467147216	19	61	127.0.0.1	38475	ACTIVE
wait/io/socket/sql/client_connection	140629467156176	16	37		0	ACTIVE
wait/io/socket/sql/server_unix_socket	140629467186192	1	14		0	ACTIVE
wait/io/socket/sql/client_connection	140629467255408	18	60	127.0.0.1	38474	ACTIVE
wait/io/socket/sql/server_tcpip_socket	140629467267056	1	13	0.0.0.0	13000	ACTIVE
# DEBUG 2a - no host, protocol
# /home/cpowers/work/dev/mysql-trunk-wl4896/client//mysql --defaults-file=/home/cpowers/work/dev/mysql-trunk-wl4896/mysql-test/var/my.cnf --protocol=TCP --port=13000 --user=root test -e "SELECT current_user();SELECT user();SELECT * FROM performance_schema.socket_instances;"
current_user()
root@localhost
user()
root@localhost
EVENT_NAME	OBJECT_INSTANCE_BEGIN	THREAD_ID	SOCKET_ID	IP	PORT	STATE
wait/io/socket/sql/client_connection	140629467097936	21	62	127.0.0.1	38478	ACTIVE
wait/io/socket/sql/client_connection	140629467147216	19	61	127.0.0.1	38475	ACTIVE
wait/io/socket/sql/client_connection	140629467156176	16	37		0	ACTIVE
wait/io/socket/sql/server_unix_socket	140629467186192	1	14		0	ACTIVE
wait/io/socket/sql/client_connection	140629467255408	18	60	127.0.0.1	38474	ACTIVE
wait/io/socket/sql/server_tcpip_socket	140629467267056	1	13	0.0.0.0	13000	ACTIVE
# DEBUG 2b - after execs
SELECT * FROM performance_schema.socket_instances;
EVENT_NAME	OBJECT_INSTANCE_BEGIN	THREAD_ID	SOCKET_ID	IP	PORT	STATE
wait/io/socket/sql/client_connection	140629467147216	19	61	127.0.0.1	38475	ACTIVE
wait/io/socket/sql/client_connection	140629467156176	16	37		0	ACTIVE
wait/io/socket/sql/server_unix_socket	140629467186192	1	14		0	ACTIVE
wait/io/socket/sql/client_connection	140629467255408	18	60	127.0.0.1	38474	ACTIVE
wait/io/socket/sql/server_tcpip_socket	140629467267056	1	13	0.0.0.0	13000	ACTIVE
# Store the thread id of connection 1 (tcp/ip)
SELECT THREAD_ID INTO @thread_id
FROM performance_schema.threads
WHERE PROCESSLIST_ID = CONNECTION_ID();
# Store the port of connection 1 (tcp/ip)
SELECT PORT INTO @port
FROM performance_schema.socket_instances
WHERE THREAD_ID = @thread_id;
# Switch to connection default
# Establish a second local TCP/IP connection (con2,127.0.0.1,root,,test,,)
# DEBUG 3
SELECT * FROM performance_schema.socket_instances;
EVENT_NAME	OBJECT_INSTANCE_BEGIN	THREAD_ID	SOCKET_ID	IP	PORT	STATE
wait/io/socket/sql/client_connection	140629467147216	19	61	127.0.0.1	38475	ACTIVE
wait/io/socket/sql/client_connection	140629467156176	16	37		0	ACTIVE
wait/io/socket/sql/server_unix_socket	140629467186192	1	14		0	ACTIVE
wait/io/socket/sql/client_connection	140629467195600	22	62	127.0.0.1	38479	ACTIVE
wait/io/socket/sql/client_connection	140629467255408	18	60	127.0.0.1	38474	ACTIVE
wait/io/socket/sql/server_tcpip_socket	140629467267056	1	13	0.0.0.0	13000	ACTIVE
# Store the thread_id of connection 2 (tcp/ip)
SELECT THREAD_ID INTO @thread_id
FROM performance_schema.threads
WHERE PROCESSLIST_ID = CONNECTION_ID();
# Store the port of connection 2 (tcp/ip)
SELECT PORT INTO @port
FROM performance_schema.socket_instances
WHERE THREAD_ID = @thread_id;
# Switch to connection default
# Establish local unix domain connection (con3,localhost,root,,test,,)
# DEBUG 4
SELECT * FROM performance_schema.socket_instances;
EVENT_NAME	OBJECT_INSTANCE_BEGIN	THREAD_ID	SOCKET_ID	IP	PORT	STATE
wait/io/socket/sql/client_connection	140629467073520	23	63		0	ACTIVE
wait/io/socket/sql/client_connection	140629467147216	19	61	127.0.0.1	38475	ACTIVE
wait/io/socket/sql/client_connection	140629467156176	16	37		0	ACTIVE
wait/io/socket/sql/server_unix_socket	140629467186192	1	14		0	ACTIVE
wait/io/socket/sql/client_connection	140629467195600	22	62	127.0.0.1	38479	ACTIVE
wait/io/socket/sql/client_connection	140629467255408	18	60	127.0.0.1	38474	ACTIVE
wait/io/socket/sql/server_tcpip_socket	140629467267056	1	13	0.0.0.0	13000	ACTIVE
# Store the thread id of connection 3 (unix domain)
SELECT THREAD_ID INTO @thread_id
FROM performance_schema.threads
WHERE PROCESSLIST_ID = CONNECTION_ID();
# Store the port of connection 3 (unix domain)
SELECT PORT INTO @port
FROM performance_schema.socket_instances
WHERE THREAD_ID = @thread_id;
# Switch to connection default
# EVENT_NAME is the "wait/io/socket/*" instrument identifier.
SELECT COUNT(*) = 0 AS "Expect 1"
FROM performance_schema.socket_instances
WHERE EVENT_NAME NOT LIKE 'wait/io/socket/%';
Expect 1
1
# OBJECT_INSTANCE_BEGIN is an arbitrary identifier, guaranteed to be unique.
SELECT COUNT(*) = COUNT(DISTINCT OBJECT_INSTANCE_BEGIN) AS "Expect 1"
FROM performance_schema.socket_instances;
Expect 1
1
# SOCKET_ID is the internal file handle assigned to the socket.
SELECT COUNT(*) = COUNT(DISTINCT SOCKET_ID) AS "Expect 1"
FROM performance_schema.socket_instances;
Expect 1
1
# Characteristics per our thread
#    There must be only one entry with our thread_id
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = @thread_id;
Expect 1
1
# TCP/IP connections should have a unique port number
# Connection 1 (tcp/ip)
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE PORT = @port;
Expect 1
1
# Connection 2 (tcp/ip)
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE PORT = @port;
Expect 1
1
#    Check the content for the default connection (unix domain)
SELECT COUNT(*) = 1 as 'Expect 1'
FROM performance_schema.socket_instances
WHERE EVENT_NAME = 'wait/io/socket/sql/client_connection'
AND PORT = 0 AND THREAD_ID = @thread_id;
Expect 1
1
# Characteristics of 'server_tcpip_socket' entry
#    Server listening socket, TCP/IP
#    There is only one entry with 'wait/io/socket/sql/server_tcpip_socket'.
#    It shares the same thread id as 'wait/io/socket/sql/server_unix_socket'.
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE EVENT_NAME = 'wait/io/socket/sql/server_tcpip_socket';
Expect 1
1
# Get the 'server_tcpip_socket' thread id
SELECT THREAD_ID INTO @thread_id
FROM performance_schema.socket_instances
WHERE EVENT_NAME = 'wait/io/socket/sql/server_tcpip_socket';
#    Check the content.
SELECT THREAD_ID = @thread_id
AND PORT = <MASTER_MYPORT> AND IP = '0.0.0.0'
     AND STATE = 'ACTIVE' AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE EVENT_NAME = 'wait/io/socket/sql/server_tcpip_socket';
Expect 1
1
# Characteristics of 'server_unix_socket' entry
#    Server listening socket, unix domain (socket file)
#    There is only one entry with 'wait/io/socket/sql/server_unix_socket'.
#    It shares the same thread id as 'wait/io/socket/sql/server_tcpip_socket'.
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE EVENT_NAME = 'wait/io/socket/sql/server_unix_socket';
Expect 1
1
# Get the 'server_unix_socket' thread id
SELECT THREAD_ID INTO @thread_id
FROM performance_schema.socket_instances
WHERE EVENT_NAME = 'wait/io/socket/sql/server_unix_socket';
#    Check the content.
SELECT THREAD_ID = @thread_id
AND PORT = 0 AND IP = ''
     AND STATE = 'ACTIVE' AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE EVENT_NAME = 'wait/io/socket/sql/server_unix_socket';
Expect 1
1
# Server listening sockets (TCP and Unix) are handled on the same thread
SELECT COUNT(*) = 2 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = @thread_id;
Expect 1
1
SELECT COUNT(*) = 2 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = @thread_id;
Expect 1
1
#Compare server listener socket thread ids
select @match_thread_id;
@match_thread_id
1
#    Check content for client connection 1 (tcpip)
SELECT EVENT_NAME = 'wait/io/socket/sql/client_connection'
        AND IP = '127.0.0.1'
        AND PORT = @port
AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = @thread_id;
Expect 1
1
# Characteristics of entries with THREAD_ID of con1
#    There is only one entry with this id.
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = @thread_id;
Expect 1
1
#    Check content for client connection 2 (tcpip)
SELECT EVENT_NAME = 'wait/io/socket/sql/client_connection'
        AND IP = '127.0.0.1'
        AND PORT = @port
AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = @thread_id;
Expect 1
1
# Characteristics of entries with THREAD_ID of con2
#    There is only one entry with this id.
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = @thread_id;
Expect 1
1
#    Check the content for client connection 3 (unix domain).
SELECT EVENT_NAME = 'wait/io/socket/sql/client_connection'
     AND IP = ''
     AND PORT = 0
AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = @thread_id;
Expect 1
1
# Characteristics of entries with THREAD_ID of con3
#    There is only one entry with this id.
SELECT COUNT(*) = 1 AS 'Expect 1'
FROM performance_schema.socket_instances
WHERE THREAD_ID = @thread_id;
Expect 1
1
# Show differences to socket_instances before con1, con2 and con3 connecting
SELECT EVENT_NAME, IP
FROM performance_schema.socket_instances
WHERE (EVENT_NAME,OBJECT_INSTANCE_BEGIN,THREAD_ID,SOCKET_ID,IP,PORT,STATE)
NOT IN (SELECT EVENT_NAME,OBJECT_INSTANCE_BEGIN,THREAD_ID,SOCKET_ID,IP,PORT,STATE
FROM my_socket_instances)
ORDER BY THREAD_ID;
EVENT_NAME	IP
wait/io/socket/sql/client_connection	127.0.0.1
wait/io/socket/sql/client_connection	127.0.0.1
wait/io/socket/sql/client_connection	127.0.0.1
wait/io/socket/sql/client_connection	
# Disconnect con1, con2 and con3
# Show differences to socket_instances before con1,con1 connecting.
# There should be none.
SELECT *
FROM performance_schema.socket_instances
WHERE (EVENT_NAME,OBJECT_INSTANCE_BEGIN,THREAD_ID,SOCKET_ID,IP,PORT,STATE)
NOT IN (SELECT EVENT_NAME,OBJECT_INSTANCE_BEGIN,THREAD_ID,SOCKET_ID,IP,PORT,STATE
FROM my_socket_instances)
ORDER BY THREAD_ID;
EVENT_NAME	OBJECT_INSTANCE_BEGIN	THREAD_ID	SOCKET_ID	IP	PORT	STATE
wait/io/socket/sql/client_connection	140629467147216	19	61	127.0.0.1	38475	ACTIVE
