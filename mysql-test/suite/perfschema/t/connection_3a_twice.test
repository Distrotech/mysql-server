# Copyright (c) 2011, Oracle and/or its affiliates. All rights reserved.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

# Tests for the performance schema
#

--source ../include/connection_setup.inc
--source ../include/connection_load.inc
--source ../include/connection_cleanup.inc

# The reason for repeating this test twice is as follows:
# after the first payload, the default root@localhost session
# sometimes deadlocks during disconnect, in a state where:
# the session is removed from information_schema.processlist
# the session is still present in performance_schema.threads
# This was originally found with:
# ./mtr --suite=perfschema --repeat=2 connection_3a
#
# This test verifies that a disconnect of the default session
# is performed gracefully

connect (conrootb, localhost, root, , );

echo "conrootb connected";

select count(*) from information_schema.processlist;
select count(*) from performance_schema.threads
  where `TYPE` = 'foreground' and processlist_user='root';

--disconnect default

--connection conrootb

# Wait for the disconnect to complete in the information_schema

let $wait_condition=
  select count(*) = 1 from information_schema.processlist;
--source include/wait_condition.inc

# Wait for the disconnect to complete in the performance_schema

let $wait_condition=
  select count(*) = 1 from performance_schema.threads
  where `TYPE`='FOREGROUND' and PROCESSLIST_USER = 'root';
--source include/wait_condition.inc

echo "default disconnected";

select count(*) from information_schema.processlist;
select count(*) from performance_schema.threads
  where `TYPE` = 'foreground' and processlist_user='root';

# Now, restore a default connection again, and resume testing

connect (default, localhost, root, , );

echo "default re connected";

select count(*) from information_schema.processlist;
select count(*) from performance_schema.threads
  where `TYPE` = 'foreground' and processlist_user='root';

--disconnect conrootb

--connection default

# Wait for the disconnect to complete in the information_schema

let $wait_condition=
  select count(*) = 1 from information_schema.processlist;
--source include/wait_condition.inc

# Wait for the disconnect to complete in the performance_schema

let $wait_condition=
  select count(*) = 1 from performance_schema.threads
  where `TYPE`='FOREGROUND' and PROCESSLIST_USER = 'root';
--source include/wait_condition.inc

echo "conrootb disconnected";

select count(*) from information_schema.processlist;
select count(*) from performance_schema.threads
  where `TYPE` = 'foreground' and processlist_user='root';

--source ../include/connection_setup.inc
--source ../include/connection_load.inc
--source ../include/connection_cleanup.inc

