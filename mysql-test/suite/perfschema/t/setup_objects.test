# Copyright (c) 2010, Oracle and/or its affiliates. All rights reserved.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

--source include/not_embedded.inc
--source include/have_perfschema.inc

--disable_warnings
drop table if exists test.setup_objects;
--enable_warnings

# Save the setup
create table test.setup_objects as select * from performance_schema.setup_objects;
truncate table performance_schema.setup_objects;

insert into performance_schema.setup_objects
  values ('TABLE', 'db1', 't1', 'YES');

insert into performance_schema.setup_objects
  values ('TABLE', 'db1', 't2', 'NO');

insert into performance_schema.setup_objects
  values ('TABLE', 'db1', '%', 'YES');

insert into performance_schema.setup_objects
  values ('TABLE', 'db2', 't1', 'YES');

insert into performance_schema.setup_objects
  values ('TABLE', 'db2', 't2', 'NO');

select * from performance_schema.setup_objects
  order by OBJECT_TYPE, OBJECT_SCHEMA, OBJECT_NAME;

--disable_warnings
drop database if exists db1;
drop database if exists db2;
drop database if exists db3;
--enable_warnings

create database db1;
create database db2;
create database db3;

create table db1.t1(a int);
create table db1.t2(a int);
create table db1.t3(a int);
create table db1.t4(a int);
create table db1.t5(a int);

create table db2.t1(a int);
create table db2.t2(a int);
create table db2.t3(a int);
create table db2.t4(a int);
create table db2.t5(a int);

create table db3.t1(a int);

select * from db1.t1;
select * from db1.t2;
select * from db1.t3;
select * from db1.t4;
select * from db1.t5;

select * from db2.t1;
select * from db2.t2;
select * from db2.t3;
select * from db2.t4;
select * from db2.t5;

select * from db3.t1;

create table db3.t2(a int);
select * from db3.t2;

# Verify what is instrumented
select distinct OBJECT_TYPE, OBJECT_NAME, OBJECT_SCHEMA 
  from performance_schema.events_waits_history_long
  where OBJECT_SCHEMA like "db%"
  group by OBJECT_TYPE, OBJECT_NAME, OBJECT_SCHEMA
  order by OBJECT_TYPE, OBJECT_NAME, OBJECT_SCHEMA;

# Verify what is instrumented and timed
select distinct OBJECT_TYPE, OBJECT_NAME, OBJECT_SCHEMA 
  from performance_schema.events_waits_history_long
  where OBJECT_SCHEMA like "db%" and TIMER_END is not NULL
  group by OBJECT_TYPE, OBJECT_NAME, OBJECT_SCHEMA
  order by OBJECT_TYPE, OBJECT_NAME, OBJECT_SCHEMA;

update performance_schema.setup_objects
  set timed='YES' where OBJECT_SCHEMA = '%';

create table db3.t3(a int);
select * from db3.t3;

truncate table performance_schema.setup_objects;

select count(*) from performance_schema.setup_objects;

drop database db1;
drop database db2;
drop database db3;

# Restore the setup
truncate table performance_schema.setup_objects;
insert into performance_schema.setup_objects select * from test.setup_objects;
drop table test.setup_objects;

