stop slave;
drop table if exists t1,t2,t3,t4,t5,t6,t7,t8,t9;
reset master;
reset slave;
drop table if exists t1,t2,t3,t4,t5,t6,t7,t8,t9;
start slave;
call mtr.add_suppression('Slave can not handle replication events with the checksum that master is configured to log');
call mtr.add_suppression('Replication event checksum verification failed');
call mtr.add_suppression('Relay log write failure: could not queue event from master');
set @save_binlog_checksum= @@global.binlog_checksum;
set @save_master_verify_checksum =  @@global.master_verify_checksum;
select @@global.binlog_checksum as 'must be one because of the command line option';
must be one because of the command line option
1
select @@session.binlog_checksum as 'no session var';
ERROR HY000: Variable 'binlog_checksum' is a GLOBAL variable
select @@global.master_verify_checksum  as 'must be zero because of default';
must be zero because of default
0
select @@session.master_verify_checksum  as 'no session var';
ERROR HY000: Variable 'master_verify_checksum' is a GLOBAL variable
set @save_slave_sql_verify_checksum = @@global.slave_sql_verify_checksum;
select @@global.slave_sql_verify_checksum  as 'must be one because of default';
must be one because of default
1
select @@session.slave_sql_verify_checksum  as 'no session var';
ERROR HY000: Variable 'slave_sql_verify_checksum' is a GLOBAL variable
show binary logs;
Log_name	File_size
master-bin.000001	#
set @@global.binlog_checksum = 0;
*** must be rotations seen ***
show binary logs;
Log_name	File_size
master-bin.000001	#
master-bin.000002	#
set @@global.binlog_checksum = default;
set @@global.binlog_checksum = 1;
set @@global.binlog_checksum = 1;
set @@global.master_verify_checksum = 0;
set @@global.master_verify_checksum = default;
set @@global.binlog_checksum = 2;
ERROR 42000: Variable 'binlog_checksum' can't be set to the value of '2'
set @@global.master_verify_checksum = 2;
ERROR 42000: Variable 'master_verify_checksum' can't be set to the value of '2'
set @@global.slave_sql_verify_checksum = 0;
set @@global.slave_sql_verify_checksum = default;
set @@global.slave_sql_verify_checksum = 2;
ERROR 42000: Variable 'slave_sql_verify_checksum' can't be set to the value of '2'
set @@global.binlog_checksum = 0;
create table t1 (a int);
flush logs;
select count(*) as zero from t1;
zero
0
include/stop_slave.inc
set @@global.binlog_checksum = 1;
insert into t1 values (1) /* will not be applied on slave due to simulation */;
set @@global.debug='d,simulate_slave_unaware_checksum';
start slave;
*** Got IO thread error code: 1665, text: Slave can not handle replication events with the checksum that master is configured to log. ***
select count(*) as zero from t1;
zero
0
set @@global.debug='';
include/start_slave.inc
set @@global.master_verify_checksum = 1;
set @@session.debug='d,simulate_checksum_test_failure';
show binlog events;
ERROR HY000: Error when executing command SHOW BINLOG EVENTS: Wrong offset or I/O error
set @@session.debug='';
set @@global.master_verify_checksum = default;
include/stop_slave.inc
create table t2 (a int);
set @@global.debug='d,simulate_checksum_test_failure';
start slave io_thread;
*** Got IO thread error code: 1595, text: Relay log write failure: could not queue event from master ***
set @@global.debug='';
start slave io_thread;
set @@global.slave_sql_verify_checksum = 1;
set @@global.debug='d,simulate_checksum_test_failure';
start slave sql_thread;
*** Got SQL thread error code: 1593, text: Error initializing relay log position: I/O error reading event at position 4 ***
set @@global.debug='';
stop slave;
include/start_slave.inc
drop table t1, t2;
set @@global.binlog_checksum = @save_binlog_checksum;
set @@global.master_verify_checksum = @save_master_verify_checksum;
set @@global.slave_sql_verify_checksum = @save_slave_sql_verify_checksum;
End of tests
