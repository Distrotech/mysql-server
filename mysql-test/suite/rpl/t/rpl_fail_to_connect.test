# ==== Purpose ====
#
# Test that the slave fails to resume replication from a position
# in the master binlog if the binlog was removed (e.g purged).
# The test is similar to a first part of rpl_gtid_lost_fail_to_connect and its intention
# is to explore circumstances under which the latter fails on PB.

--source include/master-slave.inc
call mtr.add_suppression("Got fatal error 1236 from master when reading data from binary log: 'Could not find first log file name in binary log index file'");

--echo ######## Initialize ########

CREATE TABLE t1 (a INT) ENGINE = InnoDB;
--sync_slave_with_master
--source include/stop_slave.inc

--connection master
INSERT INTO t1 VALUES (1);
FLUSH LOGS;
--let $master_file= query_get_value(SHOW MASTER STATUS, File, 1)
--let $master_pos= query_get_value(SHOW MASTER STATUS, Position, 1)
INSERT INTO t1 VALUES (2);
--save_master_pos
eval PURGE BINARY LOGS TO '$master_file';

--connection slave

START SLAVE;

--let $slave_io_errno= 1236 # ER_MASTER_FATAL_ERROR_READING_BINLOG
--source include/wait_for_slave_io_error.inc
--source include/stop_slave_sql.inc

--connection master
RESET MASTER;

--connection slave
RESET SLAVE;
--source include/start_slave.inc

--echo ######## Clean up ########
--connection master
DROP TABLE t1;

--connection slave
--source include/rpl_end.inc
