--source include/master-slave.inc

--let $uuid= aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa

--echo ==== Error values for ugid_next ====

SELECT @@SESSION.UGID_NEXT;
SELECT @@SESSION.UGID_NEXT_LIST;

SET @@SESSION.UGID_NEXT= "ANONYMOUS";
SELECT @@SESSION.UGID_NEXT;

SET @@SESSION.UGID_NEXT= "AUTOMATIC";
SELECT @@SESSION.UGID_NEXT;

eval SET @@SESSION.UGID_NEXT= "$uuid:10";
SELECT @@SESSION.UGID_NEXT;

eval SET @@SESSION.UGID_NEXT= "$uuid:0x10";
SELECT @@SESSION.UGID_NEXT;

eval SET @@SESSION.UGID_NEXT= "$uuid:010";
SELECT @@SESSION.UGID_NEXT;

--error 1231 # ER_WRONG_VALUE_FOR_VAR
eval SET @@SESSION.UGID_NEXT= "$uuid:10#";
SELECT @@SESSION.UGID_NEXT;

--error 1231 # ER_WRONG_VALUE_FOR_VAR
eval SET @@SESSION.UGID_NEXT= "$uuid:1-10";
SELECT @@SESSION.UGID_NEXT;

--error 1231 # ER_WRONG_VALUE_FOR_VAR
eval SET @@SESSION.UGID_NEXT= "$uuid:1:3";
SELECT @@SESSION.UGID_NEXT;

--error 1231 # ER_WRONG_VALUE_FOR_VAR
eval SET @@SESSION.UGID_NEXT= "$uuid:1,$uuid:3";
SELECT @@SESSION.UGID_NEXT;

--error 1231 # ER_WRONG_VALUE_FOR_VAR
SET @@SESSION.UGID_NEXT= NULL;
SELECT @@SESSION.UGID_NEXT;

--error 1232 # ER_WRONG_VALUE_FOR_VAR
SET @@SESSION.UGID_NEXT= 10;
SELECT @@SESSION.UGID_NEXT;

--error 1231 # ER_WRONG_VALUE_FOR_VAR
SET @@SESSION.UGID_NEXT= "10";
SELECT @@SESSION.UGID_NEXT;

--error 1231 # ER_WRONG_VALUE_FOR_VAR
eval SET @@SESSION.UGID_NEXT= "$uuid:";
SELECT @@SESSION.UGID_NEXT;

--error 1231 # ER_WRONG_VALUE_FOR_VAR
eval SET @@SESSION.UGID_NEXT= "$uuid:0";
SELECT @@SESSION.UGID_NEXT;

--error 1231 # ER_WRONG_VALUE_FOR_VAR
eval SET @@SESSION.UGID_NEXT= "$uuid:0x8000000000000000";
SELECT @@SESSION.UGID_NEXT;

--echo ==== Error values for ugid_next_list ====

SELECT @@SESSION.UGID_NEXT_LIST;

SET @@SESSION.UGID_NEXT_LIST= "";
SELECT @@SESSION.UGID_NEXT_LIST;

--error 1231 # ER_WRONG_VALUE_FOR_VAR
SET @@SESSION.UGID_NEXT_LIST= "#";
SELECT @@SESSION.UGID_NEXT_LIST;

--error 1231 # ER_WRONG_VALUE_FOR_VAR
SET @@SESSION.UGID_NEXT_LIST= "0aaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1:0aaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1";
SELECT @@SESSION.UGID_NEXT_LIST;

SET @@SESSION.UGID_NEXT_LIST= NULL;
SELECT @@SESSION.UGID_NEXT_LIST;

SET @@SESSION.UGID_NEXT_LIST= "0aaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1";
SELECT @@SESSION.UGID_NEXT_LIST;

SET @@SESSION.UGID_NEXT_LIST= "1aaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-10";
SELECT @@SESSION.UGID_NEXT_LIST;

SET @@SESSION.UGID_NEXT_LIST= "2aaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-10:2-20";
SELECT @@SESSION.UGID_NEXT_LIST;

SET @@SESSION.UGID_NEXT_LIST= "3aaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa :1-10:11-20";
SELECT @@SESSION.UGID_NEXT_LIST;

SET @@SESSION.UGID_NEXT_LIST= "4aaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa: 1-10:14-20";
SELECT @@SESSION.UGID_NEXT_LIST;

SET @@SESSION.UGID_NEXT_LIST= "5aaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:4 -10:1-20";
SELECT @@SESSION.UGID_NEXT_LIST;

SET @@SESSION.UGID_NEXT_LIST= "6aaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:4- 10:8-20";
SELECT @@SESSION.UGID_NEXT_LIST;

SET @@SESSION.UGID_NEXT_LIST= "7aaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:4-10 :4-20";
SELECT @@SESSION.UGID_NEXT_LIST;

SET @@SESSION.UGID_NEXT_LIST= "8aaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:4-10:15-20:11-14 ";
SELECT @@SESSION.UGID_NEXT_LIST;

SET @@SESSION.UGID_NEXT_LIST= "9aaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa
: 1 - 10,
9aaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa    :       11 -     20     ";
SELECT @@SESSION.UGID_NEXT_LIST;

SET @@SESSION.UGID_NEXT_LIST= "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-10,0aaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:11-20,aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:11-20";
SELECT @@SESSION.UGID_NEXT_LIST;

--echo ==== Error conditions for setting ugid_next and ugid_next_list ====

SET UGID_NEXT_LIST = NULL, UGID_NEXT = "AUTOMATIC", UGID_END = 0, UGID_COMMIT = 0;

CREATE TABLE variables (var VARCHAR(100), val VARCHAR(100), id INT PRIMARY KEY AUTO_INCREMENT);
eval INSERT INTO variables(var, val) VALUES
  ('ugid_next', '"$uuid:1"'),
  ('ugid_next_list', '"$uuid:1"'),
  ('ugid_end', '1'),
  ('ugid_commit', '1');
--eval CREATE FUNCTION return_ugid() RETURNS VARCHAR(100) BEGIN RETURN '$uuid:1'; END
CREATE USER nonsuper@localhost;
GRANT SELECT ON *.* TO nonsuper@localhost;
--connect (nonsuper,localhost,nonsuper,,)
--connection master

--let $id= 1
while ($id <= 4)
{
  --let $var= `SELECT var FROM variables WHERE id = $id`
  --let $val= `SELECT val FROM variables WHERE id = $id`

  --echo ---- @@SESSION.$var ----

  # can't set value from stored function
  --eval CREATE FUNCTION f () RETURNS INT BEGIN SET @@SESSION.$var = $val; RETURN 1; END
  --error 1739 # ER_VARIABLE_NOT_SETTABLE_IN_SUB_STATEMENT
  SELECT f();
  DROP FUNCTION f;

  # can't set value from trigger
  --eval CREATE TRIGGER t BEFORE INSERT ON variables FOR EACH ROW SET @@SESSION.$var = $val
  --error 1739 # ER_VARIABLE_NOT_SETTABLE_IN_SUB_STATEMENT
  INSERT INTO variables(var) VALUES ('a');
  DROP TRIGGER t;

  # can't set value when invoking SF
  --error 1744 # ER_SET_STATEMENT_CANNOT_INVOKE_FUNCTION
  --eval SET @@SESSION.$var = return_ugid()

  # must be SUPER
  --connection nonsuper
  --error 1227 # ER_SPECIFIC_ACCESS_DENIED_ERROR
  --eval SET @@SESSION.$var = $val
  --connection master

  --eval SELECT @@SESSION.$var;

  --inc $id
}

SET UGID_NEXT_LIST = NULL;

# can set value from stored procedure (although this is weird and we
# really don't want to support it, we have to check that at least
# there is no crash)
SET UGID_NEXT_LIST = NULL, UGID_NEXT = "AUTOMATIC", UGID_END = 0, UGID_COMMIT = 0;
--delimiter |
eval CREATE PROCEDURE p ()
BEGIN
  SET @@SESSION.UGID_NEXT_LIST = "$uuid:1-10";
  SET @@SESSION.UGID_NEXT = "$uuid:50";
  SET @@SESSION.UGID_NEXT = "$uuid:5";
  SET @@SESSION.UGID_COMMIT = 1;
  SET @@SESSION.UGID_END = 1;
  SET @@SESSION.UGID_NEXT_LIST = NULL;
  SET @@SESSION.UGID_NEXT = "AUTOMATIC";
  SET @@SESSION.UGID_COMMIT = 0;
  SET @@SESSION.UGID_END = 0;
END|
--delimiter ;
CALL p();
DROP PROCEDURE p;

--echo ---- Misc. error conditions for UGID_NEXT and UGID_NEXT_LIST ----

# can't set ugid_next outside master-super-group, inside a transaction
SET UGID_NEXT_LIST = NULL;
BEGIN;
  --error 1740 # ER_VARIABLE_NOT_SETTABLE_IN_TRANSACTION
  --eval SET UGID_NEXT_LIST = "$uuid:1"
  --error 1740 # ER_VARIABLE_NOT_SETTABLE_IN_TRANSACTION
  --eval SET UGID_NEXT = "$uuid:1"
COMMIT;

# Cannot start master-super-group when ugid_next and ugid_next_list
# are incompatible.
eval SET @@SESSION.UGID_NEXT_LIST = "$uuid:1", @@SESSION.UGID_NEXT = "$uuid:2";
--error 1
BEGIN;

# In a master-super-group where ugid_next_list != NULL, ugid_next can
# only be set to a value specified in ugid_next_list, and
# ugid_next_list cannot be changed.
eval SET @@SESSION.UGID_NEXT_LIST = "$uuid:1-2", @@SESSION.UGID_NEXT = "$uuid:1";
COMMIT; # start master-super-group
--eval SET @@SESSION.UGID_NEXT = "$uuid:1";
--eval SET @@SESSION.UGID_NEXT = "$uuid:2";
--error
--eval SET @@SESSION.UGID_NEXT = "$uuid:3";
--error
--eval SET @@SESSION.UGID_NEXT_LIST = "$uuid:1-2";
--error
--eval SET @@SESSION.UGID_NEXT_LIST = "$uuid:2";
--error
--eval SET @@SESSION.UGID_NEXT_LIST = NULL;
SET @@SESSION.UGID_COMMIT = 1;
COMMIT; # end master-super-group

# In a master-super-group where ugid_next_list == NULL, neither
# ugid_next nor ugid_next_list is settable.
eval SET @@SESSION.UGID_NEXT_LIST = NULL, @@SESSION.UGID_NEXT = "$uuid:1";
COMMIT; # start master-super-group
--error 1737 # ER_CANT_CHANGE_UGID_NEXT_IN_SUPER_GROUP_WHEN_UGID_NEXT_LIST_IS_NULL
--eval SET @@SESSION.UGID_NEXT = "$uuid:1";
--error
--eval SET @@SESSION.UGID_NEXT_LIST = NULL;
--error
--eval SET @@SESSION.UGID_NEXT_LIST = "$uuid:1";
SET @@SESSION.UGID_COMMIT = 1;
COMMIT; # end master-super-group

eval SET @@SESSION.UGID_NEXT_LIST = '$uuid:1-3';
eval SET @@SESSION.UGID_NEXT = '$uuid:2';

eval SET @@SESSION.UGID_NEXT_LIST = '$uuid:1-3';
eval SET @@SESSION.UGID_NEXT = '$uuid:4';

--source include/rpl_end.inc

# ugid_next_list is not settable in a master-super-group defined by ugid_next.
eval SET @@SESSION.UGID_NEXT_LIST = NULL, @@SESSION.UGID_NEXT = "$uuid:1";
BEGIN;
--error
--eval SET @@SESSION.UGID_NEXT = "$uuid:1";
COMMIT;

    --error 1735 # ER_VARIABLE_NOT_SETTABLE_IN_TRANSACTION

    BEGIN;
    COMMIT;
