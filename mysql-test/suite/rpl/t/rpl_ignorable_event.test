#
# WL#4033
# This test verifies if the query of the rows event
# is displayed with its rows event as comment in RBR
# by SHOW BINLOG EVENTS and MYSQLBINLOG DUMP.
#
source include/have_binlog_format_row.inc;
source include/master-slave.inc;
source include/have_innodb.inc;

--echo # Test the binlog_rows_query_log_events is set to off by default
select @@session.binlog_rows_query_log_events;
set session binlog_rows_query_log_events= on;
select @@session.binlog_rows_query_log_events;

# Test non-transaction
let $binlog_start= query_get_value("SHOW MASTER STATUS", Position, 1);
create table t1(i1 int not null auto_increment, a int, b int, primary key(i1)) engine=myisam;
insert into t1(a,b) values(1,1),(2,1);
update t1 set a = a + 5 where b = 1 LIMIT 1;
delete from t1 where a = 6;
insert into t1(a,b) values(1,2);
insert into t1(a,b) values(1,3);
insert into t1(a,b) values(1,4),(1,5),(1,5),(1,5),(1,5),(1,5),(1,5),(1,5),(1,5),(1,5);
update t1 set a = a + 5 where b = 2;

# Test transaction
create table t2(a int, b int) engine=innodb;
begin;
insert into t2(a,b) values(2,1),(3,1);
insert into t2(a,b) values(2,2);
insert into t2(a,b) values(2,3);
update t2 set a = a + 5 where b = 1;
delete from t2 where a = 7;
insert into t2(a,b) values(2,4),(2,4),(2,4),(2,4),(2,4),(2,4),(2,4),(2,4),(2,4);
commit;

# Test mixed transaction
begin;
insert into t1(a,b) values(1,5);
insert into t1(a,b) values(1,6);
insert into t2(a,b) values(2,4);
insert into t2(a,b) values(2,5);
insert into t1(a,b) values(1,7);
commit;


# Test insert delayed ...
insert delayed into t1(a,b) values(1,5),(1,6),(1,7),(1,8),(1,9),(1,10);

# Test load data infile
create table t3(a VARCHAR(60)) engine=myisam;
load data infile '../../std_data/words.dat' into table t3;

create table t4(a int, b int) engine= myisam;
insert into t4(a, b) values(1,4);
update t1,t4 set t1.a=1, t4.a=4 where t1.b=t4.b;

source include/show_binlog_events.inc;

let $master_binlog= query_get_value(SHOW MASTER STATUS, File, 1);
let $MYSQLD_DATADIR= `select @@datadir`;
--replace_result $MYSQLTEST_VARDIR MYSQLTEST_VARDIR
--replace_regex /TIMESTAMP=[0-9]*/TIMESTAMP=t/ /#[0-9]*[ ]*[0-9]*:[0-9]*:[0-9]* server id [0-9]*/#server id #/ /exec_time=[0-9]*/exec_time=#/ /error_code=[0-9]*/error_code=#/ /end_log_pos [0-9]*/end_log_pos #/ /# at [0-9]*/# at #/ /Xid = [0-9]*/Xid = #/ /thread_id=[0-9]*/thread_id=#/ /table id [0-9]*/table id #/ /mapped to number [0-9]*/mapped to number #/ /server v [^ ]*/server v #.##.##/ /Start: binlog v [0-9]*/Start: binlog v#/ /created [0-9]*[ ]*[0-9]*:[0-9]*:[0-9]* at startup/created # #:#:# at startup/
--exec $MYSQL_BINLOG --base64-output=decode-rows -v -v  $MYSQLD_DATADIR/$master_binlog

set session binlog_rows_query_log_events= off;

drop table t1, t2, t3, t4;
sync_slave_with_master;

