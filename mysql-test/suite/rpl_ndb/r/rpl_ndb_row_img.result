include/stop_slave.inc
DROP TABLE IF EXISTS t1,t2,t3,t4,t5,t6,t7,t8,t9;
RESET MASTER;
RESET SLAVE;
include/stop_slave.inc
DROP TABLE IF EXISTS t1,t2,t3,t4,t5,t6,t7,t8,t9;
RESET MASTER;
RESET SLAVE;
include/stop_slave.inc
DROP TABLE IF EXISTS t1,t2,t3,t4,t5,t6,t7,t8,t9;
RESET MASTER;
RESET SLAVE;
CHANGE MASTER TO master_host='127.0.0.1',master_port=MASTER_A_PORT,master_user='root',MASTER_LOG_FILE='MASTER_A_LOG_FILE';
CHANGE MASTER TO master_host='127.0.0.1',master_port=MASTER_B_PORT,master_user='root',MASTER_LOG_FILE='MASTER_B_LOG_FILE';
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	1
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	2
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	3
include/start_slave.inc
include/start_slave.inc
include/stop_slave.inc
RESET MASTER;
RESET SLAVE;
include/stop_slave.inc
RESET MASTER;
RESET SLAVE;
RESET MASTER;
RESET SLAVE;
include/start_slave.inc
include/start_slave.inc
DROP TABLE IF EXISTS t1;
CON: 'mysqld_a', IMG: 'MINIMAL', RESTART SLAVE: 'N'
SET SESSION binlog_row_image= 'MINIMAL';
SET GLOBAL binlog_row_image= 'MINIMAL';
FLUSH TABLES;
SHOW VARIABLES LIKE 'binlog_row_image';
Variable_name	Value
binlog_row_image	MINIMAL
CON: 'mysqld_b', IMG: 'MINIMAL', RESTART SLAVE: 'Y'
SET SESSION binlog_row_image= 'MINIMAL';
SET GLOBAL binlog_row_image= 'MINIMAL';
include/stop_slave.inc
include/start_slave.inc
FLUSH TABLES;
SHOW VARIABLES LIKE 'binlog_row_image';
Variable_name	Value
binlog_row_image	MINIMAL
CON: 'mysqld_c', IMG: 'MINIMAL', RESTART SLAVE: 'Y'
SET SESSION binlog_row_image= 'MINIMAL';
SET GLOBAL binlog_row_image= 'MINIMAL';
include/stop_slave.inc
include/start_slave.inc
FLUSH TABLES;
SHOW VARIABLES LIKE 'binlog_row_image';
Variable_name	Value
binlog_row_image	MINIMAL
#### case #1: AI: no values logged
CREATE TABLE t1 (c1 int DEFAULT 100) Engine=ENGINE;
INSERT INTO t1 VALUES ();
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	1
SELECT * FROM t1;
c1
100
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	2
SELECT * FROM t1;
c1
100
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	3
SELECT * FROM t1;
c1
100
DROP TABLE t1;
#### case #2: AI: not empty but slave does not have usable data for its columns (INSERT)
CREATE TABLE t1 (c1 int DEFAULT 100) Engine=ENGINE;
SET SQL_LOG_BIN=0;
CREATE TABLE t1 (c1 int DEFAULT 100) Engine=ENGINE;
SET SQL_LOG_BIN=1;
SET SQL_LOG_BIN=0;
CREATE TABLE t1 (c1 int DEFAULT 100, c2 int, primary key(c2)) Engine=ENGINE;
SET SQL_LOG_BIN=1;
INSERT INTO t1(c2) VALUES (1);
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	1
SELECT * FROM t1;
c1	c2
100	1
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	2
SELECT * FROM t1;
c1
100
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	3
SELECT * FROM t1;
c1
100
DROP TABLE t1;
#### case #3: BI: usable columns on the slave, AI: no usable columns on the slave
CREATE TABLE t1 (c1 int DEFAULT 100) Engine=ENGINE;
SET SQL_LOG_BIN=0;
CREATE TABLE t1 (c1 int DEFAULT 100) Engine=ENGINE;
SET SQL_LOG_BIN=1;
SET SQL_LOG_BIN=0;
CREATE TABLE t1 (c1 int DEFAULT 100, c2 int) Engine=ENGINE;
SET SQL_LOG_BIN=1;
INSERT INTO t1 VALUES (1,1);
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	1
SELECT * FROM t1;
c1	c2
1	1
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	2
SELECT * FROM t1;
c1
1
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	3
SELECT * FROM t1;
c1
1
UPDATE t1 SET c2=2 WHERE c1=1 AND c2=1;
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	1
SELECT * FROM t1;
c1	c2
1	2
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	2
SELECT * FROM t1;
c1
1
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	3
SELECT * FROM t1;
c1
1
DROP TABLE t1;
#### case #4: AI, BI: no usable columns on the slave (NOOP UPDATE).
####          
CREATE TABLE t1 (c1 int DEFAULT 100) Engine=ENGINE;
SET SQL_LOG_BIN=0;
CREATE TABLE t1 (c1 int DEFAULT 100) Engine=ENGINE;
SET SQL_LOG_BIN=1;
SET SQL_LOG_BIN=0;
CREATE TABLE t1 (c1 int DEFAULT 100, c2 int, c3 int, primary key(c2)) Engine=ENGINE;
SET SQL_LOG_BIN=1;
INSERT INTO t1 VALUES (1,1,1);
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	1
SELECT * FROM t1;
c1	c2	c3
1	1	1
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	2
SELECT * FROM t1;
c1
1
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	3
SELECT * FROM t1;
c1
1
UPDATE t1 SET c3=300 WHERE c2=1;
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	1
SELECT * FROM t1;
c1	c2	c3
1	1	300
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	2
SELECT * FROM t1;
c1
1
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	3
SELECT * FROM t1;
c1
1
DROP TABLE t1;
#### case #5: BI: no usable columns on the slave, AI: usable columns on the slave (slave must stop).
#### 
include/stop_slave.inc
RESET MASTER;
RESET SLAVE;
include/stop_slave.inc
RESET MASTER;
RESET SLAVE;
RESET MASTER;
RESET SLAVE;
include/start_slave.inc
include/start_slave.inc
CREATE TABLE t1 (c1 INT DEFAULT 100) Engine=ENGINE;
SET SQL_LOG_BIN=0;
CREATE TABLE t1 (c1 INT DEFAULT 100) Engine=ENGINE;
SET SQL_LOG_BIN=1;
SET SQL_LOG_BIN=0;
CREATE TABLE t1 (c1 INT DEFAULT 100, c2 INT PRIMARY KEY) Engine=ENGINE;
SET SQL_LOG_BIN=1;
INSERT INTO t1 VALUES (1,1);
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	1
SELECT * FROM t1;
c1	c2
1	1
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	2
SELECT * FROM t1;
c1
1
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	3
SELECT * FROM t1;
c1
1
UPDATE t1 SET c1=300 WHERE c2=1;
SHOW VARIABLES LIKE 'server_id';
Variable_name	Value
server_id	1
SELECT * FROM t1;
c1	c2
300	1
SET SQL_LOG_BIN=0;
call mtr.add_suppression("Slave: Can\'t find record in \'t1\' Error_code: 1032");
SET SQL_LOG_BIN=1;
### SLAVE STOPPED AS EXPECTED!
include/stop_slave.inc
RESET MASTER;
RESET SLAVE;
include/stop_slave.inc
RESET MASTER;
RESET SLAVE;
RESET MASTER;
RESET SLAVE;
include/start_slave.inc
include/start_slave.inc
DROP TABLE IF EXISTS t1;
CON: 'mysqld_a', IMG: 'FULL', RESTART SLAVE: 'N'
SET SESSION binlog_row_image= 'FULL';
SET GLOBAL binlog_row_image= 'FULL';
FLUSH TABLES;
SHOW VARIABLES LIKE 'binlog_row_image';
Variable_name	Value
binlog_row_image	FULL
CON: 'mysqld_b', IMG: 'FULL', RESTART SLAVE: 'Y'
SET SESSION binlog_row_image= 'FULL';
SET GLOBAL binlog_row_image= 'FULL';
include/stop_slave.inc
include/start_slave.inc
FLUSH TABLES;
SHOW VARIABLES LIKE 'binlog_row_image';
Variable_name	Value
binlog_row_image	FULL
CON: 'mysqld_c', IMG: 'FULL', RESTART SLAVE: 'Y'
SET SESSION binlog_row_image= 'FULL';
SET GLOBAL binlog_row_image= 'FULL';
include/stop_slave.inc
include/start_slave.inc
FLUSH TABLES;
SHOW VARIABLES LIKE 'binlog_row_image';
Variable_name	Value
binlog_row_image	FULL
